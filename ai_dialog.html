<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分支式AI对话界面</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --user-bubble: #e3f2fd;
            --ai-bubble: #f5f5f5;
            --branch-color: #8bc34a;
            --border-color: #ddd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --selected-bg: rgba(74, 111, 165, 0.1);
            --selected-border: #4a6fa5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            height: 100vh;
            background-color: #f9f9f9;
        }
        
        /* 分支面板样式 */
        .branch-panel {
            width: 280px;
            background-color: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .branch-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .branch-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .branch-node {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            border-left: 3px solid transparent;
        }
        
        .branch-node.active {
            background-color: var(--user-bubble);
            border-left-color: var(--primary-color);
        }
        
        .branch-node:hover {
            background-color: #f0f0f0;
        }
        
        .branch-content {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .branch-actions {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        /* 对话面板样式 */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }
        
        .chat-header {
            padding: 15px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .message.selected {
            background-color: var(--selected-bg);
            border: 2px solid var(--selected-border);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background-color: var(--user-bubble);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message {
            background-color: var(--ai-bubble);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            display: none;
            padding: 5px;
        }
        
        .message:hover .message-actions {
            display: flex;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            margin: 0 2px;
            color: #666;
        }
        
        .action-btn:hover {
            background-color: #f0f0f0;
            color: var(--primary-color);
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
        }
        
        .chat-input textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            height: 60px;
        }
        
        .chat-input button {
            margin-left: 10px;
            padding: 0 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .branch-indicator {
            font-size: 0.8em;
            color: var(--branch-color);
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        
        .branch-indicator::before {
            content: "•";
            margin-right: 5px;
            color: var(--branch-color);
        }
        
        /* 分支创建面板 */
        .branch-create {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            z-index: 100;
            width: 300px;
            display: none;
        }
        
        .branch-create h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .branch-create textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            margin-bottom: 10px;
        }
        
        .branch-create-buttons {
            display: flex;
            justify-content: flex-end;
        }
        
        .branch-create-buttons button {
            margin-left: 10px;
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .branch-create-buttons .cancel {
            background-color: #f5f5f5;
        }
        
        .branch-create-buttons .create {
            background-color: var(--branch-color);
            color: white;
        }
        
        /* 合并分支面板 */
        .merge-panel {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            z-index: 100;
            width: 350px;
            display: none;
        }
        
        .merge-branches {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .merge-branch {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .merge-branch.selected {
            border-color: var(--branch-color);
            background-color: rgba(139, 195, 74, 0.1);
        }
        
        /* 合并选项样式 */
        .merge-options {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .merge-options h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
        
        .merge-option {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
        }
        
        .merge-option input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .merge-option span {
            font-size: 13px;
            color: #555;
            cursor: pointer;
        }
        
        /* 系统消息样式 */
        .message.system {
            background-color: #fff9c4;
            border-left: 4px solid #ffc107;
        }
        
        .branch-start-point {
            background-color: rgba(139, 195, 74, 0.1);
            border-left: 3px solid var(--branch-color);
        }
        
        /* 选择计数和操作栏 */
        .selection-actions {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 25px;
            box-shadow: var(--shadow);
            padding: 10px 20px;
            display: none;
            z-index: 1000;
            gap: 15px;
            align-items: center;
        }
        
        .selection-count {
            font-size: 14px;
            color: #666;
        }
        
        .create-from-selection,
        .clear-selection {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-selection {
            background-color: #666;
        }
        
        .create-from-selection:hover {
            background-color: #2980b9;
        }
        
        .clear-selection:hover {
            background-color: #444;
        }
        
        /* 选中的消息样式 */
        .message.selected {
            background-color: rgba(139, 195, 74, 0.2);
            border-left: 4px solid var(--branch-color);
        }
        
        /* 流程图样式 */
        .flow-graph-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .flow-graph-container {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .flow-graph-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-graph-header h3 {
            color: var(--primary-color);
        }
        
        .flow-graph-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .flow-graph-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .flow-graph-svg {
            width: 100%;
            height: 100%;
            background-color: #f9f9f9;
        }
        
        .graph-node {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .graph-node:hover {
            transform: scale(1.05);
        }
        
        .graph-node circle {
            stroke: var(--border-color);
            stroke-width: 2;
        }
        
        .graph-node text {
            font-size: 12px;
            pointer-events: none;
            text-anchor: middle;
        }
        
        .graph-edge {
            stroke: var(--border-color);
            stroke-width: 2;
            fill: none;
        }
        
        .graph-node.active circle {
            stroke: var(--primary-color);
            stroke-width: 3;
        }
        
        .summary-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 500px;
            max-width: 90%;
            display: none;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .summary-modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .summary-content {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            min-height: 100px;
            margin-bottom: 15px;
        }
        
        .summary-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .summary-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .summary-actions .cancel {
            background-color: #f5f5f5;
        }
        
        .summary-actions .create-branch {
            background-color: var(--branch-color);
            color: white;
        }
        
        /* 内容标记样式 */
        .message.content-marked {
            border-left: 4px solid #ffc107;
            background-color: rgba(255, 193, 7, 0.05);
        }
        
        .action-btn.mark-content {
            font-size: 14px;
        }
        
        /* 已标记内容模态框 */
        .marked-contents-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .marked-contents-container {
            background-color: white;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .marked-contents-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .marked-contents-header h3 {
            color: var(--primary-color);
            margin: 0;
        }
        
        .marked-contents-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .marked-contents-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .marked-content-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .marked-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .marked-content-type {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .marked-content-date {
            font-size: 12px;
            color: #666;
        }
        
        .delete-marked {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        
        .marked-content-body {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        /* 提示消息样式 */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 3000;
        }
        
        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- 分支面板 -->
    <div class="branch-panel">
        <div class="branch-header">
            <h3>对话分支</h3>
        </div>
        <div class="branch-tree" id="branchTree">
            <!-- 分支节点将通过JavaScript动态生成 -->
        </div>
        <div class="branch-actions">
            <button id="newMainBranch">新建主分支</button>
            <button id="mergeBranches">合并分支</button>
        </div>
    </div>
    
    <!-- 对话面板 -->
    <div class="chat-panel">
        <div class="chat-header">
            <h3 id="currentBranchName">主分支</h3>
            <div class="branch-info">
                <span id="branchPath">路径: 主分支</span>
            </div>
            <button id="viewFlowGraph" title="查看对话流程图">📊</button>
            <button id="showMarkedContents" title="查看已标记内容">⭐</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- 对话消息将通过JavaScript动态生成 -->
        </div>
        <div class="chat-input">
            <textarea id="messageInput" placeholder="输入您的消息..."></textarea>
            <button id="sendMessage">发送</button>
        </div>
        
        <!-- 消息选择操作栏 -->
        <div class="selection-actions" id="selectionActions">
            <span class="selection-count" id="selectionCount">已选择 0 条消息</span>
            <button class="create-from-selection" id="createFromSelection">基于选中内容创建分支</button>
            <button class="create-from-selection" id="generateSummary">生成摘要</button>
            <button class="clear-selection" id="clearSelection">清除选择</button>
        </div>
    </div>
    
    <!-- 分支创建面板 -->
    <div class="branch-create" id="branchCreatePanel">
        <h3>创建新分支</h3>
        <p>新分支将从选定的消息开始</p>
        <div class="branch-create-buttons">
            <button class="cancel" id="cancelBranch">取消</button>
            <button class="create" id="createBranch">创建</button>
        </div>
    </div>
    

    
    <!-- 流程图模态框 -->
    <div class="flow-graph-modal" id="flowGraphModal">
        <div class="flow-graph-container">
            <div class="flow-graph-header">
                <h3>对话流程图</h3>
                <button class="flow-graph-close" id="closeFlowGraph">×</button>
            </div>
            <div class="flow-graph-content">
                <svg class="flow-graph-svg" id="flowGraphSvg"></svg>
            </div>
        </div>
    </div>
    
    <!-- 摘要模态框 -->
    <div class="summary-modal" id="summaryModal">
        <h3>会话摘要</h3>
        <div class="summary-content" id="summaryContent"></div>
        <div class="summary-actions">
            <button class="cancel" id="cancelSummary">关闭</button>
            <button class="create-branch" id="createBranchFromSummary">基于摘要创建分支</button>
        </div>
    </div>
    
    <!-- 已标记内容模态框 -->
    <div class="marked-contents-modal" id="markedContentsModal">
        <div class="marked-contents-container">
            <div class="marked-contents-header">
                <h3>已标记内容</h3>
                <button class="marked-contents-close" id="closeMarkedContents">×</button>
            </div>
            <div class="marked-contents-body">
                <div id="markedContentsList"></div>
            </div>
        </div>
    </div>
    <div class="merge-panel" id="mergePanel">
        <h3>合并分支</h3>
        <p>选择要合并到当前分支的分支：</p>
        <div class="merge-branches" id="mergeBranchesList">
            <!-- 可合并的分支将通过JavaScript动态生成 -->
        </div>
        <div class="merge-options">
            <h4>合并方式：</h4>
            <label class="merge-option">
                <input type="radio" name="mergeType" value="migrate" checked>
                <span>迁移所有聊天气泡，按时间顺序重排</span>
            </label>
            <label class="merge-option">
                <input type="radio" name="mergeType" value="summary">
                <span>生成摘要，作为单个气泡添加</span>
            </label>
        </div>
        <div class="branch-create-buttons">
            <button class="cancel" id="cancelMerge">取消</button>
            <button class="create" id="confirmMerge">合并</button>
        </div>
    </div>

    <style>
        /* 模型选择相关样式 */
        .model-switch-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            min-width: 300px;
            display: none;
        }
        
        .model-switch-panel h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
        }
        
        .model-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .model-option:hover {
            background-color: #f5f5f5;
        }
        
        .model-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .model-switch-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .model-switch-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .model-switch-buttons .cancel {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .model-switch-buttons .confirm {
            background-color: var(--primary-color);
            color: white;
        }
        
        .model-name {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
            font-style: italic;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        
        /* 模型标签样式 */
        .model-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            background-color: #f0f0f0;
            color: #666;
        }
    </style>
    
    <div id="modalOverlay" class="modal-overlay"></div>
    
    <!-- 模型切换面板 -->
    <div id="modelSwitchPanel" class="model-switch-panel">
        <h3>切换AI模型</h3>
        <div class="model-options">
            <label class="model-option">
                <input type="radio" name="modelType" value="default" checked>
                <div>
                    <span>通用助手</span>
                    <div class="model-name">平衡的通用对话模型</div>
                </div>
            </label>
            <label class="model-option">
                <input type="radio" name="modelType" value="technical">
                <div>
                    <span>技术专家</span>
                    <div class="model-name">专注于技术问题的模型</div>
                </div>
            </label>
            <label class="model-option">
                <input type="radio" name="modelType" value="creative">
                <div>
                    <span>创意生成器</span>
                    <div class="model-name">擅长创意内容生成的模型</div>
                </div>
            </label>
            <label class="model-option">
                <input type="radio" name="modelType" value="simplifier">
                <div>
                    <span>简化解释师</span>
                    <div class="model-name">擅长用简单语言解释复杂概念的模型</div>
                </div>
            </label>
        </div>
        <div class="model-switch-buttons">
            <button class="cancel" onclick="hideModelSwitchPanel()">取消</button>
            <button class="confirm" onclick="switchAIModel()">切换</button>
        </div>
    </div>
    
    <script>
        // 对话数据结构 - 小说创作主题
        let conversationData = {
            branches: {
                'main': {
                    id: 'main',
                    name: '小说大纲',
                    messages: [
                        { id: 'm1', role: 'user', content: '我想写一部科幻小说，你能帮我构思大纲吗？', timestamp: new Date() },
                        { id: 'm2', role: 'ai', content: '当然可以！科幻小说的大纲通常包含以下元素：设定背景、主要人物、核心冲突、情节发展和结局。我们可以一步步来构建。首先，你对故事背景有什么初步想法吗？比如未来的时间点、主要场景、科技发展水平等。', timestamp: new Date(), model: 'creative' },
                        { id: 'm3', role: 'user', content: '我想设定在2150年，人类已经开始殖民火星，但地球面临着严重的环境问题。主要场景可以在火星殖民地和地球之间切换。', timestamp: new Date() },
                        { id: 'm4', role: 'ai', content: '这是个很棒的设定！现在让我们继续构思主要人物和核心冲突。你希望故事围绕怎样的人物展开？可能的核心冲突是什么？', timestamp: new Date(), model: 'creative' },
                        { id: 'm5', role: 'user', content: '主角可以是一名火星殖民地的工程师，他发现了一个可能改变人类命运的科学突破，但这个突破同时也带来了巨大的伦理争议。他必须在个人理想和人类福祉之间做出抉择。', timestamp: new Date() },
                        { id: 'm6', role: 'ai', content: '非常引人入胜的设定！让我们整理一下目前的小说大纲：\n\n**小说标题：** 星际抉择\n\n**背景设定：** 2150年，人类已在火星建立殖民地，地球环境恶化严重。\n\n**主要人物：**\n- 李星辰：32岁，火星殖民地的首席工程师，聪明、理想主义，但有时过于执着。\n- 张雨晴：28岁，地球环境科学家，李星辰的前女友，坚持环境保护理念。\n- 马库斯：45岁，火星殖民地总督，务实派，关注殖民地的生存与发展。\n\n**核心冲突：** 李星辰发现了一种能够大幅提高粮食产量的基因技术，但这项技术可能对生态系统造成未知的长期影响。他必须在技术进步和环境保护之间做出抉择。\n\n**情节发展：**\n1. 开场：火星殖民地的日常生活，李星辰的工作与压力\n2. 发现：李星辰在实验中偶然发现了关键技术突破\n3. 争议：技术公布后引发的伦理与安全争议\n4. 抉择：李星辰面临来自各方的压力，必须做出最终决定\n5. 高潮：技术应用后的意外后果，李星辰必须采取行动\n6. 结局：李星辰的选择及其对人类未来的影响\n\n你觉得这个大纲如何？我们可以进一步细化或者调整。', timestamp: new Date(), model: 'creative' },
                        { id: 'm7', role: 'user', content: '非常好！现在我需要为每个章节编写详细内容。我想从第一章开始，描述火星殖民地的环境和主角的日常生活。', timestamp: new Date() },
                        { id: 'm8', role: 'ai', content: '好的，第一章是建立故事世界和介绍主角的关键。我们可以创建一个新的分支来专门编写第一章的内容，这样可以保持主线大纲的清晰，同时又能深入发展各个章节的细节。', timestamp: new Date(), model: 'creative' }
                    ],
                    parent: null,
                    children: ['chapter1', 'chapter2', 'chapter3']
                },
                'chapter1': {
                    id: 'chapter1',
                    name: '第1章：红色星球的黎明',
                    messages: [
                        { id: 'c1m1', role: 'user', content: '我需要详细描写火星殖民地的环境，包括穹顶城市的结构、火星表面的景观，以及主角李星辰的日常生活。', timestamp: new Date() },
                        { id: 'c1m2', role: 'ai', content: '没问题！让我们开始构建第一章的内容。\n\n**第1章：红色星球的黎明**\n\n晨光透过穹顶的特种玻璃，在火星殖民地的金属地板上投下淡红色的光斑。李星辰站在实验室的窗边，望着外面贫瘠的红色荒原。远处，巨大的太阳能板在阳光下闪闪发光，像一片金属的海洋。\n\n"星哥，又在看地球了？"助手小陈的声音从身后传来。\n\n李星辰转身，露出一个疲惫的微笑。"是啊，有点想家了。"他走到实验台前，看着培养皿中正在生长的新型作物。这些经过基因改良的植物，是解决殖民地粮食问题的关键。\n\n"今天的实验数据怎么样？"李星辰问道，戴上手套开始检查样本。\n\n"情况不太乐观，"小陈皱着眉头说，"第三组样本的生长速度比预期慢了30%。"\n\n李星辰的手指微微一顿。这已经是连续第三次出现这样的问题了。如果不能解决这个难题，殖民地的粮食供应将面临严重危机...\n\n这个开头怎么样？我们可以继续完善和扩展。', timestamp: new Date(), model: 'creative' },
                        { id: 'c1m3', role: 'user', content: '很好！我想增加一些主角的内心描写，以及他与前女友张雨晴的回忆，为后续剧情做铺垫。', timestamp: new Date() },
                        { id: 'c1m4', role: 'ai', content: '好主意！加入这些元素可以使人物形象更加丰满，也能为后续的冲突埋下伏笔。\n\n**第1章：红色星球的黎明（续）**\n\n李星辰的目光落在实验台角落的一张照片上。照片里，他和张雨晴站在地球的海滩上，阳光洒在他们的笑脸上。那是三年前，在他决定前往火星之前拍摄的。\n\n"雨晴，你说得对，"他轻声自语，"人类确实应该更加尊重自然规律。但现在..."他望着培养皿中的作物，"我们没有时间了。"\n\n三年前的争吵仿佛还在耳边。"星辰，你总是这么急功近利！"张雨晴的声音带着哭腔，"基因技术不是万能的，你难道不担心会有什么可怕的后果吗？"\n\n"但如果我们不冒险，人类就没有未来！"李星辰当时的回答斩钉截铁。\n\n现在回想起来，他有些后悔当时的态度。但木已成舟，他已经来到了火星，肩负着数百人生命的重担...\n\n你觉得这样修改如何？我们可以继续添加更多细节。', timestamp: new Date(), model: 'creative' }
                    ],
                    parent: {
                        branch: 'main',
                        messageIds: ['m7', 'm8']
                    },
                    children: []
                },
                'chapter2': {
                    id: 'chapter2',
                    name: '第2章：意外的发现',
                    messages: [
                        { id: 'c2m1', role: 'user', content: '在第二章中，我希望主角李星辰在实验中偶然发现关键的技术突破。这个发现应该既令人兴奋，又充满潜在的风险。', timestamp: new Date() },
                        { id: 'c2m2', role: 'ai', content: '明白！让我们来设计这个关键的发现场景。\n\n**第2章：意外的发现**\n\n深夜，实验室的灯光依然亮着。李星辰揉了揉疲惫的眼睛，盯着显微镜下的细胞样本。已经连续工作了16个小时，他的脑海里全是各种数据和公式。\n\n突然，他的眼睛一亮。显微镜下的细胞结构有些不同寻常——细胞核周围环绕着一圈微弱的光晕。这是之前从未观察到的现象。\n\n"小陈！快过来！"李星辰的声音有些颤抖。\n\n小陈揉着眼睛走进实验室："星哥，这么晚了还没休息？"\n\n"你看这个！"李星辰让开位置，"这个样本的基因表达模式完全不同！"\n\n小陈凑近显微镜，眼睛也立刻亮了起来："这...这不可能！我们的改良方案不应该有这种效果！"\n\n李星辰迅速转身，开始在电脑上输入指令："马上准备测序！我要知道这个样本的全部基因序列！"\n\n三个小时后，测序结果出来了。李星辰盯着电脑屏幕上的数据，双手微微颤抖。这个意外的突变，竟然让作物的生长速度提高了五倍，同时对火星的恶劣环境有了更强的适应性。\n\n但在兴奋之余，他的心里也升起了一丝担忧。这个突变是如何发生的？它真的安全吗？\n\n"也许，"他望着窗外的红色荒原，"这就是人类的转机。"\n\n你觉得这个发现场景如何？我们可以根据需要调整细节。', timestamp: new Date(), model: 'creative' }
                    ],
                    parent: {
                        branch: 'main',
                        messageIds: ['m7', 'm8']
                    },
                    children: []
                },
                'chapter3': {
                    id: 'chapter3',
                    name: '第3章：伦理的争议',
                    messages: [
                        { id: 'c3m1', role: 'user', content: '在第三章中，我希望描述技术公布后引发的伦理和安全争议。特别是主角的前女友张雨晴作为地球环境科学家，可能会强烈反对这项技术。', timestamp: new Date() },
                        { id: 'c3m2', role: 'ai', content: '这个冲突设计非常精彩！伦理争议是科幻小说中常见但深刻的主题。\n\n**第3章：伦理的争议**\n\n新闻发布会的现场一片哗然。当李星辰展示最新的实验数据时，台下的记者们纷纷举起了手，问题一个接一个地抛过来。\n\n"李博士，这项技术的安全性如何？你们做过长期的环境影响评估吗？"\n\n"这项技术是否可能导致不可控的基因扩散？"\n\n"有人担心这会开启基因编辑的潘多拉魔盒，您对此有何回应？"\n\n李星辰保持着冷静："我们的实验数据表明，这项技术是安全可控的。它将帮助人类解决粮食危机，特别是在火星这样的极端环境中。"\n\n但争议并没有就此平息。当天晚上，李星辰收到了一封来自地球的加密邮件。发件人是张雨晴。\n\n"星辰，你疯了吗？"邮件的开头充满了指责，"这项技术的风险是不可预测的！你还记得我们之前的争论吗？你当时说要谨慎，但现在你却在拿全人类的未来冒险！"\n\n李星辰的手指停在键盘上。他知道张雨晴是对的，这项技术确实存在未知的风险。但火星殖民地的粮食储备只能维持三个月了，他没有时间等待更多的安全评估。\n\n"我必须这么做，"他在心里默默地说，"为了这里的每一个人。"\n\n你觉得这个冲突场景如何？我们可以继续深入探讨不同角色的立场和动机。', timestamp: new Date(), model: 'creative' }
                    ],
                    parent: {
                        branch: 'main',
                        messageIds: ['m7', 'm8']
                    },
                    children: []
                }
            },
            currentBranch: 'main',
            currentModel: 'creative'
        };
        
        // 定义可用的AI模型
        const availableModels = [
            { id: 'default', name: '通用助手', description: '平衡的通用对话模型' },
            { id: 'technical', name: '技术专家', description: '专注于技术问题的模型' },
            { id: 'creative', name: '创意生成器', description: '擅长创意内容生成的模型' },
            { id: 'simplifier', name: '简化解释师', description: '擅长用简单语言解释复杂概念的模型' }
        ];
        
        // 存储当前选中的消息ID
        let selectedMessages = [];
        // 存储已标记的消息内容
        let markedContents = [];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            renderBranchTree();
            renderCurrentBranch();
            
            // 发送消息事件
            document.getElementById('sendMessage').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 分支创建事件
            document.getElementById('newMainBranch').addEventListener('click', showBranchCreatePanel);
            document.getElementById('cancelBranch').addEventListener('click', hideBranchCreatePanel);
            document.getElementById('createBranch').addEventListener('click', createNewBranch);
            
            // 合并分支事件
            document.getElementById('mergeBranches').addEventListener('click', showMergePanel);
            document.getElementById('cancelMerge').addEventListener('click', hideMergePanel);
            document.getElementById('confirmMerge').addEventListener('click', mergeBranches);
            
            // 基于选中内容创建分支事件
            document.getElementById('createFromSelection').addEventListener('click', createBranchFromSelection);
            document.getElementById('clearSelection').addEventListener('click', clearMessageSelection);
            document.getElementById('generateSummary').addEventListener('click', generateSummary);
            
            // 流程图相关事件
            document.getElementById('viewFlowGraph').addEventListener('click', showFlowGraph);
            document.getElementById('closeFlowGraph').addEventListener('click', hideFlowGraph);
            
            // 摘要相关事件
            document.getElementById('cancelSummary').addEventListener('click', hideSummary);
            document.getElementById('createBranchFromSummary').addEventListener('click', createBranchFromSummary);
            
            // 已标记内容相关事件
            document.getElementById('showMarkedContents').addEventListener('click', showMarkedContents);
            document.getElementById('closeMarkedContents').addEventListener('click', hideMarkedContents);
        });

        // 渲染分支树
        function renderBranchTree() {
            const branchTree = document.getElementById('branchTree');
            branchTree.innerHTML = '';
            
            // 递归渲染分支
            function renderBranch(branchId, level = 0) {
                const branch = conversationData.branches[branchId];
                const branchNode = document.createElement('div');
                branchNode.className = `branch-node ${conversationData.currentBranch === branchId ? 'active' : ''}`;
                branchNode.style.paddingLeft = `${10 + level * 20}px`;
                branchNode.dataset.branchId = branchId;
                
                branchNode.innerHTML = `
                    <div class="branch-name">${branch.name}</div>
                    <div class="branch-content">${branch.messages[branch.messages.length - 1]?.content.substring(0, 30) || '空分支'}...</div>
                `;
                
                branchNode.addEventListener('click', () => switchBranch(branchId));
                branchTree.appendChild(branchNode);
                
                // 渲染子分支
                branch.children.forEach(childId => {
                    renderBranch(childId, level + 1);
                });
            }
            
            // 从根分支开始渲染
            Object.keys(conversationData.branches).forEach(branchId => {
                if (!conversationData.branches[branchId].parent) {
                    renderBranch(branchId);
                }
            });
        }

        // 渲染当前分支的对话
        function renderCurrentBranch() {
            const chatMessages = document.getElementById('chatMessages');
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            chatMessages.innerHTML = '';
            currentBranch.messages.forEach((message, index) => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.role === 'user' ? 'user-message' : message.role === 'ai' ? 'ai-message' : 'system'}`;
                messageElement.dataset.messageId = message.id;
                
                // 标记分支起始点
                if (currentBranch.parent && index === 0) {
                    messageElement.classList.add('branch-start-point');
                }
                
                messageElement.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-actions">
                        <button class="action-btn select-message" title="选择/取消选择此消息">✅</button>
                        <button class="action-btn branch-from-here" title="从此处创建分支(包含所有历史)">🌿</button>
                        <button class="action-btn branch-only-this" title="仅以此内容为基础创建分支">✂️</button>
                        <button class="action-btn highlight-keywords" title="标记关键词">🔖</button>
                        <button class="action-btn mark-content" title="标记内容">⭐</button>
                        <button class="action-btn switch-model" title="切换AI模型" ${message.role !== 'ai' ? 'style="display:none"' : ''}>🔄</button>
                    </div>
                `;
                
                // 重新设置data-message-id属性，确保toggleMessageSelection能找到元素
                messageElement.dataset.messageId = message.id;
                
                chatMessages.appendChild(messageElement);
                
                // 添加消息选择事件
                messageElement.addEventListener('click', (e) => {
                    // 只有当点击的是消息内容区域时才触发选择
                    const contentElement = messageElement.querySelector('.message-content');
                    if (e.target === contentElement || contentElement.contains(e.target)) {
                        toggleMessageSelection(message.id);
                    }
                });
                
                // 添加多选按钮事件
                messageElement.querySelector('.select-message').addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMessageSelection(message.id);
                });
                
                // 添加分支创建事件 - 直接创建分支而不显示面板
                messageElement.querySelector('.branch-from-here').addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 直接创建分支 - 包含所有历史消息
                    const newBranchId = 'branch_' + Date.now();
                    const currentBranch = conversationData.branches[conversationData.currentBranch];
                    
                    // 确定新分支的起始消息索引
                    let startingPoint = 0;
                    if (message.id) {
                        startingPoint = currentBranch.messages.findIndex(m => m.id === message.id);
                    }
                    
                    // 创建新分支 - 只包含起始点及之前的消息
                    conversationData.branches[newBranchId] = {
                        id: newBranchId,
                        name: `分支 ${Object.keys(conversationData.branches).length}`,
                        messages: [
                            // 只包含起始点及之前的消息
                            ...currentBranch.messages.slice(0, startingPoint + 1)
                        ],
                        parent: {
                            branch: conversationData.currentBranch,
                            messageId: message.id
                        },
                        children: []
                    };
                    
                    // 将新分支添加到当前分支的子分支中
                    currentBranch.children.push(newBranchId);
                    
                    // 切换到新分支
                    switchBranch(newBranchId);
                });
                
                // 添加标记内容事件
                    messageElement.querySelector('.mark-content').addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleContentMark(message.id, message.content, message.role);
                    });
                    
                    // 添加切换模型事件
                    if (message.role === 'ai') {
                        messageElement.querySelector('.switch-model').addEventListener('click', (e) => {
                            e.stopPropagation();
                            showModelSwitchPanel(message.id);
                        });
                    }
                    
                    // 添加仅以此内容为基础创建分支的事件
                    messageElement.querySelector('.branch-only-this').addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 直接创建分支 - 仅包含选中的消息内容
                    const newBranchId = 'branch_' + Date.now();
                    const currentBranch = conversationData.branches[conversationData.currentBranch];
                    
                    // 创建新分支 - 只包含选中的消息
                    conversationData.branches[newBranchId] = {
                        id: newBranchId,
                        name: `仅选分支 ${Object.keys(conversationData.branches).length}`,
                        messages: [
                            // 仅包含选中的消息
                            {
                                ...message, // 复制选中的消息内容
                                id: 'm' + Date.now() // 生成新的ID以避免冲突
                            }
                        ],
                        parent: {
                            branch: conversationData.currentBranch,
                            messageId: message.id
                        },
                        children: []
                    };
                    
                    // 将新分支添加到当前分支的子分支中
                    currentBranch.children.push(newBranchId);
                    
                    // 切换到新分支
                    switchBranch(newBranchId);
                });
            });
            
            // 更新分支信息
            document.getElementById('currentBranchName').textContent = currentBranch.name;
            document.getElementById('branchPath').textContent = `路径: ${getBranchPath(currentBranch.id)}`;
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 获取分支路径
        function getBranchPath(branchId) {
            let path = [];
            let currentBranch = conversationData.branches[branchId];
            
            while (currentBranch) {
                path.unshift(currentBranch.name);
                if (currentBranch.parent) {
                    currentBranch = conversationData.branches[currentBranch.parent.branch];
                } else {
                    currentBranch = null;
                }
            }
            
            return path.join(' → ');
        }

        // 发送消息
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                const currentBranch = conversationData.branches[conversationData.currentBranch];
                const messageId = 'm' + Date.now();
                
                // 添加用户消息
                currentBranch.messages.push({
                    id: messageId,
                    role: 'user',
                    content: message,
                    timestamp: new Date()
                });
                
                // 模拟AI回复
                setTimeout(() => {
                    const aiMessageId = 'm' + Date.now();
                    currentBranch.messages.push({
                        id: aiMessageId,
                        role: 'ai',
                        content: generateAIResponse(message, currentBranch.messages),
                        timestamp: new Date()
                    });
                    
                    renderCurrentBranch();
                    renderBranchTree();
                }, 1000);
                
                renderCurrentBranch();
                input.value = '';
            }
        }

        // 生成AI回复（模拟）
        function generateAIResponse(userMessage, messageHistory, modelId = 'default') {
            // 不同模型的响应模式
            const modelResponses = {
                default: [
                    "这是一个很好的问题！让我详细解释一下。",
                    "基于我们之前的对话，我认为...",
                    "您提到了一个关键点。关于这一点，我想补充...",
                    "我理解您的疑问。实际上，这个问题可以从多个角度来理解...",
                    "感谢您的提问！这让我想到了相关的概念..."
                ],
                technical: [
                    "从技术角度分析，这个问题涉及到以下几个核心概念：",
                    "根据我的技术理解，这个问题可以通过以下方法解决：",
                    "这个技术问题的关键点在于...",
                    "从实现细节来看，我们需要考虑...",
                    "在技术选型上，我建议..."
                ],
                creative: [
                    "让我从创意的角度来思考这个问题...",
                    "这里有一些创造性的解决方案...",
                    "换个角度看，我们可以这样尝试...",
                    "创意层面上，这个问题可以有多种有趣的解决方式...",
                    "从创新视角出发，我想到了以下可能性..."
                ],
                simplifier: [
                    "简单来说，这个问题可以这样理解...",
                    "让我用更简单的语言解释一下...",
                    "其实这个概念并不复杂，本质上就是...",
                    "为了更容易理解，我们可以这样比喻...",
                    "简化一下，核心思想是..."
                ]
            };
            
            const responses = modelResponses[modelId] || modelResponses.default;
            
            // 简单模拟根据消息历史生成回复
            if (userMessage.includes('?')) {
                const modelPrefixes = {
                    default: "这个问题很有深度。简而言之，我认为...",
                    technical: "根据技术原理，这个问题的答案是...",
                    creative: "从创意角度出发，我的看法是...",
                    simplifier: "简单来说，答案可以这样理解..."
                };
                const prefix = modelPrefixes[modelId] || modelPrefixes.default;
                return prefix + responses[Math.floor(Math.random() * responses.length)];
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // 显示模型切换面板
        function showModelSwitchPanel(messageId) {
            const panel = document.getElementById('modelSwitchPanel');
            const overlay = document.getElementById('modalOverlay');
            
            // 保存当前要切换的消息ID
            panel.dataset.messageId = messageId;
            
            // 显示面板和遮罩
            panel.style.display = 'block';
            overlay.style.display = 'block';
            
            // 预选中当前模型
            const currentMessage = getMessageById(messageId);
            if (currentMessage && currentMessage.model) {
                const modelRadio = document.querySelector(`input[name="modelType"][value="${currentMessage.model}"]`);
                if (modelRadio) {
                    modelRadio.checked = true;
                }
            }
        }
        
        // 隐藏模型切换面板
        function hideModelSwitchPanel() {
            document.getElementById('modelSwitchPanel').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }
        
        // 根据消息ID获取消息对象
        function getMessageById(messageId) {
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            return currentBranch.messages.find(msg => msg.id === messageId);
        }
        
        // 切换AI模型
        function switchAIModel() {
            const panel = document.getElementById('modelSwitchPanel');
            const messageId = panel.dataset.messageId;
            const selectedModel = document.querySelector('input[name="modelType"]:checked').value;
            
            // 获取当前消息和分支
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            const messageIndex = currentBranch.messages.findIndex(msg => msg.id === messageId);
            const message = currentBranch.messages[messageIndex];
            
            // 检查消息是否存在且为AI回复
            if (messageIndex === -1 || message.role !== 'ai') {
                hideModelSwitchPanel();
                return;
            }
            
            // 更新当前模型设置
            conversationData.currentModel = selectedModel;
            
            // 生成消息摘要
            const summary = generateMessageSummary(message.content);
            
            // 创建新分支，使用新模型重新生成回复
            const newBranchId = 'branch_' + Date.now();
            
            // 复制当前分支的所有消息，直到要切换的消息之前
            const newMessages = [...currentBranch.messages.slice(0, messageIndex)];
            
            // 添加用户请求切换模型的系统消息
            newMessages.push({
                id: 'm' + Date.now(),
                role: 'system',
                content: `[切换到${availableModels.find(m => m.id === selectedModel).name}模型，基于以下内容进行重新回复]\n\n${summary}`,
                timestamp: new Date()
            });
            
            // 立即显示提示，说明正在生成新回复
            renderCurrentBranch();
            
            // 模拟新模型生成回复（使用setTimeout模拟延迟）
            setTimeout(() => {
                const newAIMessageId = 'm' + Date.now();
                const newAIMessage = {
                    id: newAIMessageId,
                    role: 'ai',
                    content: generateAIResponse(summary, newMessages, selectedModel),
                    timestamp: new Date(),
                    model: selectedModel
                };
                
                // 更新新分支消息
                newMessages.push(newAIMessage);
                
                // 创建新分支
                conversationData.branches[newBranchId] = {
                    id: newBranchId,
                    name: `[${availableModels.find(m => m.id === selectedModel).name}] ${currentBranch.name}`,
                    messages: newMessages,
                    parent: {
                        branch: conversationData.currentBranch,
                        messageId: messageId,
                        modelSwitch: true,
                        fromModel: message.model || 'default',
                        toModel: selectedModel
                    },
                    children: []
                };
                
                // 将新分支添加到当前分支的子分支中
                currentBranch.children.push(newBranchId);
                
                // 切换到新分支
                switchBranch(newBranchId);
                
                // 隐藏面板
                hideModelSwitchPanel();
            }, 1000);
        }
        
        // 生成消息摘要
        function generateMessageSummary(messageContent) {
            // 简单的摘要生成逻辑
            // 在实际应用中，这里可以使用更复杂的NLP算法
            if (messageContent.length <= 100) {
                return messageContent; // 如果消息本身就不长，直接返回
            }
            
            // 简单截取前100个字符并添加省略号
            return messageContent.substring(0, 100) + '...';
        }

        // 显示分支创建面板
        function showBranchCreatePanel(fromMessageId = null) {
            const panel = document.getElementById('branchCreatePanel');
            panel.style.display = 'block';
            panel.dataset.fromMessageId = fromMessageId;
            
            // 定位面板
            if (fromMessageId) {
                const messageElement = document.querySelector(`[data-message-id="${fromMessageId}"]`);
                const rect = messageElement.getBoundingClientRect();
                panel.style.top = `${rect.top}px`;
                panel.style.left = `${rect.right + 10}px`;
            } else {
                panel.style.top = '50%';
                panel.style.left = '50%';
                panel.style.transform = 'translate(-50%, -50%)';
            }
        }

        // 隐藏分支创建面板
        function hideBranchCreatePanel() {
            document.getElementById('branchCreatePanel').style.display = 'none';
        }

        // 创建新分支
        function createNewBranch() {
            const fromMessageId = document.getElementById('branchCreatePanel').dataset.fromMessageId;
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // 确定新分支的起始消息索引
            let startingPoint = 0;
            if (fromMessageId) {
                startingPoint = currentBranch.messages.findIndex(m => m.id === fromMessageId);
            }
            
            // 创建新分支 - 只包含起始点及之前的消息
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `分支 ${Object.keys(conversationData.branches).length}`,
                messages: [
                    // 只包含起始点及之前的消息
                    ...currentBranch.messages.slice(0, startingPoint + 1)
                ],
                parent: {
                    branch: conversationData.currentBranch,
                    messageId: fromMessageId
                },
                children: []
            };
            
            // 将新分支添加到当前分支的子分支中
            currentBranch.children.push(newBranchId);
            
            // 切换到新分支
            switchBranch(newBranchId);
            
            // 隐藏面板
            hideBranchCreatePanel();
        }

        // 切换分支
        function switchBranch(branchId) {
            conversationData.currentBranch = branchId;
            renderBranchTree();
            renderCurrentBranch();
        }

        // 切换内容标记状态
        function toggleContentMark(messageId, content, role) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            const markButton = messageElement.querySelector('.mark-content');
            
            // 检查是否已标记
            const isMarked = markedContents.some(item => item.messageId === messageId);
            
            if (isMarked) {
                // 取消标记
                markedContents = markedContents.filter(item => item.messageId !== messageId);
                messageElement.classList.remove('content-marked');
                markButton.title = '标记内容';
                markButton.textContent = '⭐';
            } else {
                // 标记内容并独立存储
                markedContents.push({
                    id: 'mc' + Date.now(),
                    messageId: messageId,
                    content: content,
                    role: role,
                    timestamp: new Date(),
                    sourceBranch: conversationData.currentBranch
                });
                messageElement.classList.add('content-marked');
                markButton.title = '取消标记';
                markButton.textContent = '★';
                
                // 显示标记成功的提示
                showToast('内容已标记并独立存储');
            }
        }
        
        // 显示提示消息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 添加动画
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3秒后自动消失
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // 显示合并分支面板
        function showMergePanel() {
            const panel = document.getElementById('mergePanel');
            const branchesList = document.getElementById('mergeBranchesList');
            
            branchesList.innerHTML = '';
            
            // 添加可合并的分支（排除当前分支）
            Object.keys(conversationData.branches).forEach(branchId => {
                if (branchId !== conversationData.currentBranch) {
                    const branch = conversationData.branches[branchId];
                    const branchElement = document.createElement('div');
                    branchElement.className = 'merge-branch';
                    branchElement.dataset.branchId = branchId;
                    branchElement.textContent = branch.name;
                    
                    branchElement.addEventListener('click', function() {
                        // 切换选中状态
                        document.querySelectorAll('.merge-branch').forEach(el => {
                            el.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    });
                    
                    branchesList.appendChild(branchElement);
                }
            });
            
            panel.style.display = 'block';
            panel.style.top = '50%';
            panel.style.left = '50%';
            panel.style.transform = 'translate(-50%, -50%)';
        }

        // 隐藏合并分支面板
        function hideMergePanel() {
            document.getElementById('mergePanel').style.display = 'none';
        }

        // 生成会话摘要
        function generateConversationSummary(messages) {
            // 简单实现：提取关键信息和主要问题
            const userMessages = messages.filter(m => m.role === 'user');
            const aiResponses = messages.filter(m => m.role === 'ai');
            
            // 提取关键词
            let keywords = [];
            userMessages.forEach(msg => {
                // 简单的关键词提取逻辑
                const words = msg.content.toLowerCase().split(/\s+/);
                const importantWords = words.filter(word => 
                    word.length > 3 && 
                    !['the', 'and', 'but', 'or', 'because', 'so', 'is', 'are', 'was', 'were'].includes(word)
                );
                keywords = [...keywords, ...importantWords];
            });
            
            // 统计关键词频率
            const keywordFreq = {};
            keywords.forEach(keyword => {
                keywordFreq[keyword] = (keywordFreq[keyword] || 0) + 1;
            });
            
            // 取最频繁的5个关键词
            const topKeywords = Object.entries(keywordFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => entry[0])
                .join(', ');
            
            // 生成摘要
            return `[分支"${conversationData.branches[conversationData.currentBranch].name}"的对话摘要]\n\n` +
                   `这是一个包含${userMessages.length}个用户提问和${aiResponses.length}个AI回复的对话。\n\n` +
                   `主要讨论内容围绕：${topKeywords}\n\n` +
                   `用户的主要问题是：${userMessages.length > 0 ? userMessages[0].content.substring(0, 100) + '...' : '无'}`;
        }
        
        // 显示已标记内容面板
        function showMarkedContents() {
            const modal = document.getElementById('markedContentsModal');
            const markedList = document.getElementById('markedContentsList');
            
            // 清空列表
            markedList.innerHTML = '';
            
            if (markedContents.length === 0) {
                markedList.innerHTML = '<div class="empty-state">暂无已标记的内容</div>';
            } else {
                // 按时间排序
                const sortedMarkedContents = [...markedContents].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // 遍历所有已标记的内容
                sortedMarkedContents.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'marked-content-item';
                    
                    const date = new Date(item.timestamp);
                    const formattedDate = date.toLocaleString();
                    
                    itemElement.innerHTML = `
                        <div class="marked-content-header">
                            <span class="marked-content-type">${item.role === 'user' ? '用户' : 'AI'}</span>
                            <span class="marked-content-date">${formattedDate}</span>
                            <button class="delete-marked" data-id="${item.messageId}" title="删除标记">🗑️</button>
                        </div>
                        <div class="marked-content-body">${item.content}</div>
                    `;
                    
                    // 添加删除事件
                    itemElement.querySelector('.delete-marked').addEventListener('click', function() {
                        const messageId = this.getAttribute('data-id');
                        toggleContentMark(messageId, '', ''); // 取消标记
                        showMarkedContents(); // 刷新列表
                    });
                    
                    markedList.appendChild(itemElement);
                });
            }
            
            modal.style.display = 'block';
        }
        
        // 隐藏已标记内容面板
        function hideMarkedContents() {
            document.getElementById('markedContentsModal').style.display = 'none';
        }
        
        // 合并分支
        function mergeBranches() {
            const selectedBranch = document.querySelector('.merge-branch.selected');
            
            if (selectedBranch) {
                const branchId = selectedBranch.dataset.branchId;
                const currentBranch = conversationData.branches[conversationData.currentBranch];
                const branchToMerge = conversationData.branches[branchId];
                
                // 获取用户选择的合并方式
                const mergeType = document.querySelector('input[name="mergeType"]:checked').value;
                
                if (mergeType === 'migrate') {
                    // 方式1：迁移所有聊天气泡，按时间顺序重排
                    // 复制所有消息并生成新的ID
                    const migratedMessages = branchToMerge.messages.map(msg => ({
                        ...msg,
                        id: 'm' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date(msg.timestamp) // 保持原始时间戳
                    }));
                    
                    // 合并并按时间排序
                    currentBranch.messages = [...currentBranch.messages, ...migratedMessages]
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                } else if (mergeType === 'summary') {
                    // 方式2：生成摘要，作为单个气泡添加
                    const summary = generateConversationSummary(branchToMerge.messages);
                    
                    currentBranch.messages.push({
                        id: 'm' + Date.now(),
                        role: 'system',
                        content: `[来自分支"${branchToMerge.name}"的摘要]\n\n${summary}`,
                        timestamp: new Date()
                    });
                }
                
                renderCurrentBranch();
                renderBranchTree();
                hideMergePanel();
            }
        }
        
        // 切换消息选择状态
        function toggleMessageSelection(messageId) {
            const index = selectedMessages.indexOf(messageId);
            
            if (index > -1) {
                // 取消选择
                selectedMessages.splice(index, 1);
                document.querySelector(`[data-message-id="${messageId}"]`).classList.remove('selected');
            } else {
                // 选择消息
                selectedMessages.push(messageId);
                document.querySelector(`[data-message-id="${messageId}"]`).classList.add('selected');
            }
            
            updateSelectionUI();
        }
        
        // 更新选择UI
        function updateSelectionUI() {
            const selectionCount = document.getElementById('selectionCount');
            const selectionActions = document.getElementById('selectionActions');
            
            selectionCount.textContent = `已选择 ${selectedMessages.length} 条消息`;
            
            if (selectedMessages.length > 0) {
                selectionActions.style.display = 'flex';
            } else {
                selectionActions.style.display = 'none';
            }
        }
        
        // 清除消息选择
        function clearMessageSelection() {
            selectedMessages.forEach(messageId => {
                document.querySelector(`[data-message-id="${messageId}"]`).classList.remove('selected');
            });
            
            selectedMessages = [];
            updateSelectionUI();
        }
        
        // 基于选中内容创建分支
        function createBranchFromSelection() {
            if (selectedMessages.length === 0) {
                return;
            }
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // 获取选中的消息并保持顺序
            const selectedMessagesData = selectedMessages
                .map(messageId => {
                    const message = currentBranch.messages.find(m => m.id === messageId);
                    return message ? { ...message, id: 'm' + Date.now() + '_' + messageId } : null;
                })
                .filter(Boolean);
            
            // 创建新分支 - 只包含选中的消息
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `多选分支 ${Object.keys(conversationData.branches).length}`,
                messages: selectedMessagesData,
                parent: {
                    branch: conversationData.currentBranch,
                    messageIds: [...selectedMessages] // 保存所有选中的消息ID用于引用
                },
                children: []
            };
            
            // 将新分支添加到当前分支的子分支中
            currentBranch.children.push(newBranchId);
            
            // 切换到新分支
            switchBranch(newBranchId);
            
            // 清除选择
            clearMessageSelection();
        }
        
        // 显示流程图
        function showFlowGraph() {
            const modal = document.getElementById('flowGraphModal');
            modal.style.display = 'flex';
            drawFlowGraph();
        }
        
        // 隐藏流程图
        function hideFlowGraph() {
            document.getElementById('flowGraphModal').style.display = 'none';
        }
        
        // 绘制流程图
        function drawFlowGraph() {
            const svg = document.getElementById('flowGraphSvg');
            svg.innerHTML = '';
            
            // 获取SVG尺寸
            const width = svg.clientWidth;
            const height = svg.clientHeight;
            
            // 设置SVG属性
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            
            // 计算节点位置的简单布局算法
            const nodes = {};
            const edges = [];
            const nodeSize = 80;
            const horizontalSpacing = 200;
            const verticalSpacing = 100;
            
            // 计算层次结构
            const levels = {};
            const rootBranches = [];
            
            // 找到根分支
            Object.keys(conversationData.branches).forEach(branchId => {
                if (!conversationData.branches[branchId].parent) {
                    rootBranches.push(branchId);
                }
            });
            
            // 分配节点位置
            function assignPositions(branchId, level = 0, position = 0) {
                if (!levels[level]) {
                    levels[level] = 0;
                }
                
                const actualPosition = levels[level]++;
                const x = 100 + level * horizontalSpacing;
                const y = 100 + actualPosition * verticalSpacing;
                
                nodes[branchId] = { x, y };
                
                // 处理子分支
                const branch = conversationData.branches[branchId];
                branch.children.forEach((childId, idx) => {
                    edges.push({ from: branchId, to: childId });
                    assignPositions(childId, level + 1, idx);
                });
            }
            
            // 从根分支开始分配位置
            rootBranches.forEach((branchId, idx) => {
                assignPositions(branchId);
            });
            
            // 绘制连接线
            edges.forEach(edge => {
                const from = nodes[edge.from];
                const to = nodes[edge.to];
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                line.classList.add('graph-edge');
                
                // 简单的贝塞尔曲线连接
                const path = `M ${from.x + nodeSize/2} ${from.y + nodeSize/2} C ${(from.x + to.x)/2} ${from.y + nodeSize/2}, ${(from.x + to.x)/2} ${to.y + nodeSize/2}, ${to.x - nodeSize/2} ${to.y + nodeSize/2}`;
                line.setAttribute('d', path);
                svg.appendChild(line);
            });
            
            // 绘制节点
            Object.keys(nodes).forEach(branchId => {
                const node = nodes[branchId];
                const branch = conversationData.branches[branchId];
                const isActive = branchId === conversationData.currentBranch;
                
                const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                nodeGroup.classList.add('graph-node');
                if (isActive) {
                    nodeGroup.classList.add('active');
                }
                
                // 节点圆
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', node.x + nodeSize/2);
                circle.setAttribute('cy', node.y + nodeSize/2);
                circle.setAttribute('r', nodeSize/2);
                circle.setAttribute('fill', branch.parent ? '#f0f0f0' : 'var(--user-bubble)');
                
                // 节点文本
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', node.x + nodeSize/2);
                text.setAttribute('y', node.y + nodeSize/2);
                text.setAttribute('dy', '0.3em');
                
                // 截断长文本
                const shortName = branch.name.length > 8 ? branch.name.substring(0, 8) + '...' : branch.name;
                text.textContent = shortName;
                
                // 添加点击事件
                nodeGroup.addEventListener('click', () => {
                    hideFlowGraph();
                    switchBranch(branchId);
                });
                
                nodeGroup.appendChild(circle);
                nodeGroup.appendChild(text);
                svg.appendChild(nodeGroup);
            })
          
        }
        
        // 生成摘要
        function generateSummary() {
            if (selectedMessages.length === 0) {
                return;
            }
            
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // 获取选中的消息并保持顺序
            const selectedMessagesData = currentBranch.messages
                .filter(message => selectedMessages.includes(message.id))
                .sort((a, b) => currentBranch.messages.indexOf(a) - currentBranch.messages.indexOf(b));
            
            // 简单的摘要生成逻辑
            let summary = "";
            
            // 统计用户和AI的发言次数
            const userMessages = selectedMessagesData.filter(m => m.role === 'user');
            const aiMessages = selectedMessagesData.filter(m => m.role === 'ai');
            
            // 提取关键词（简单实现）
            const keywords = extractKeywords(selectedMessagesData.map(m => m.content).join(' '));
            
            // 生成摘要文本
            summary += `这段对话包含 ${userMessages.length} 条用户消息和 ${aiMessages.length} 条AI回复。\n\n`;
            
            if (keywords.length > 0) {
                summary += `讨论的主要关键词：${keywords.join(', ')}\n\n`;
            }
            
            // 提取用户的主要问题
            if (userMessages.length > 0) {
                summary += "用户的主要问题/关注点：\n";
                userMessages.forEach((msg, idx) => {
                    // 只显示不太长的消息
                    const shortContent = msg.content.length > 80 ? msg.content.substring(0, 80) + '...' : msg.content;
                    summary += `- ${shortContent}\n`;
                });
            }
            
            // 更新摘要内容
            document.getElementById('summaryContent').textContent = summary;
            
            // 显示摘要模态框
            document.getElementById('summaryModal').style.display = 'block';
        }
        
        // 简单的关键词提取函数
        function extractKeywords(text) {
            // 移除常见停用词
            const stopwords = ['的', '了', '在', '是', '我', '有', '和', '就', '不', '人', '都', '一', '一个', '上', '也', '很', '到', '说', '要', '去', '你', '会', '着', '没有', '看', '好', '自己', '这'];
            
            // 分词并过滤
            const words = text
                .replace(/[.,?!;:"“”‘’()\[\]{}]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 1 && !stopwords.includes(word))
                .map(word => word.toLowerCase());
            
            // 统计词频
            const wordCounts = {};
            words.forEach(word => {
                wordCounts[word] = (wordCounts[word] || 0) + 1;
            });
            
            // 排序并返回前5个关键词
            return Object.keys(wordCounts)
                .sort((a, b) => wordCounts[b] - wordCounts[a])
                .slice(0, 5);
        }
        
        // 隐藏摘要
        function hideSummary() {
            document.getElementById('summaryModal').style.display = 'none';
        }
        
        // 基于摘要创建分支
        function createBranchFromSummary() {
            const summary = document.getElementById('summaryContent').textContent;
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // 创建新分支 - 只包含摘要消息
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `摘要分支 ${Object.keys(conversationData.branches).length}`,
                messages: [
                    {
                        id: 'm' + Date.now(),
                        role: 'user',
                        content: '基于以下摘要继续讨论：\n' + summary,
                        timestamp: new Date()
                    }
                ],
                parent: {
                    branch: conversationData.currentBranch,
                    summaryBased: true,
                    messageIds: [...selectedMessages] // 保存所有选中的消息ID用于引用
                },
                children: []
            };
            
            // 将新分支添加到当前分支的子分支中
            currentBranch.children.push(newBranchId);
            
            // 切换到新分支
            switchBranch(newBranchId);
            
            // 隐藏摘要模态框
            hideSummary();
            
            // 清除选择
            clearMessageSelection();
        }
    </script>
</body>
</html>