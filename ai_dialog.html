<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ”¯å¼AIå¯¹è¯ç•Œé¢</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --user-bubble: #e3f2fd;
            --ai-bubble: #f5f5f5;
            --branch-color: #8bc34a;
            --border-color: #ddd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --selected-bg: rgba(74, 111, 165, 0.1);
            --selected-border: #4a6fa5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            height: 100vh;
            background-color: #f9f9f9;
        }
        
        /* åˆ†æ”¯é¢æ¿æ ·å¼ */
        .branch-panel {
            width: 280px;
            background-color: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .branch-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .branch-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .branch-node {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            border-left: 3px solid transparent;
        }
        
        .branch-node.active {
            background-color: var(--user-bubble);
            border-left-color: var(--primary-color);
        }
        
        .branch-node:hover {
            background-color: #f0f0f0;
        }
        
        .branch-content {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .branch-actions {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        /* å¯¹è¯é¢æ¿æ ·å¼ */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }
        
        .chat-header {
            padding: 15px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .message.selected {
            background-color: var(--selected-bg);
            border: 2px solid var(--selected-border);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background-color: var(--user-bubble);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message {
            background-color: var(--ai-bubble);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            display: none;
            padding: 5px;
        }
        
        .message:hover .message-actions {
            display: flex;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            margin: 0 2px;
            color: #666;
        }
        
        .action-btn:hover {
            background-color: #f0f0f0;
            color: var(--primary-color);
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
        }
        
        .chat-input textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            height: 60px;
        }
        
        .chat-input button {
            margin-left: 10px;
            padding: 0 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .branch-indicator {
            font-size: 0.8em;
            color: var(--branch-color);
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        
        .branch-indicator::before {
            content: "â€¢";
            margin-right: 5px;
            color: var(--branch-color);
        }
        
        /* åˆ†æ”¯åˆ›å»ºé¢æ¿ */
        .branch-create {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            z-index: 100;
            width: 300px;
            display: none;
        }
        
        .branch-create h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .branch-create textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            margin-bottom: 10px;
        }
        
        .branch-create-buttons {
            display: flex;
            justify-content: flex-end;
        }
        
        .branch-create-buttons button {
            margin-left: 10px;
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .branch-create-buttons .cancel {
            background-color: #f5f5f5;
        }
        
        .branch-create-buttons .create {
            background-color: var(--branch-color);
            color: white;
        }
        
        /* åˆå¹¶åˆ†æ”¯é¢æ¿ */
        .merge-panel {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            z-index: 100;
            width: 350px;
            display: none;
        }
        
        .merge-branches {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .merge-branch {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .merge-branch.selected {
            border-color: var(--branch-color);
            background-color: rgba(139, 195, 74, 0.1);
        }
        
        /* åˆå¹¶é€‰é¡¹æ ·å¼ */
        .merge-options {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .merge-options h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
        
        .merge-option {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
        }
        
        .merge-option input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .merge-option span {
            font-size: 13px;
            color: #555;
            cursor: pointer;
        }
        
        /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
        .message.system {
            background-color: #fff9c4;
            border-left: 4px solid #ffc107;
        }
        
        .branch-start-point {
            background-color: rgba(139, 195, 74, 0.1);
            border-left: 3px solid var(--branch-color);
        }
        
        /* é€‰æ‹©è®¡æ•°å’Œæ“ä½œæ  */
        .selection-actions {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 25px;
            box-shadow: var(--shadow);
            padding: 10px 20px;
            display: none;
            z-index: 1000;
            gap: 15px;
            align-items: center;
        }
        
        .selection-count {
            font-size: 14px;
            color: #666;
        }
        
        .create-from-selection,
        .clear-selection {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-selection {
            background-color: #666;
        }
        
        .create-from-selection:hover {
            background-color: #2980b9;
        }
        
        .clear-selection:hover {
            background-color: #444;
        }
        
        /* é€‰ä¸­çš„æ¶ˆæ¯æ ·å¼ */
        .message.selected {
            background-color: rgba(139, 195, 74, 0.2);
            border-left: 4px solid var(--branch-color);
        }
        
        /* æµç¨‹å›¾æ ·å¼ */
        .flow-graph-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .flow-graph-container {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .flow-graph-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-graph-header h3 {
            color: var(--primary-color);
        }
        
        .flow-graph-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .flow-graph-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .flow-graph-svg {
            width: 100%;
            height: 100%;
            background-color: #f9f9f9;
        }
        
        .graph-node {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .graph-node:hover {
            transform: scale(1.05);
        }
        
        .graph-node circle {
            stroke: var(--border-color);
            stroke-width: 2;
        }
        
        .graph-node text {
            font-size: 12px;
            pointer-events: none;
            text-anchor: middle;
        }
        
        .graph-edge {
            stroke: var(--border-color);
            stroke-width: 2;
            fill: none;
        }
        
        .graph-node.active circle {
            stroke: var(--primary-color);
            stroke-width: 3;
        }
        
        .summary-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 500px;
            max-width: 90%;
            display: none;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .summary-modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .summary-content {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            min-height: 100px;
            margin-bottom: 15px;
        }
        
        .summary-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .summary-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .summary-actions .cancel {
            background-color: #f5f5f5;
        }
        
        .summary-actions .create-branch {
            background-color: var(--branch-color);
            color: white;
        }
    </style>
</head>
<body>
    <!-- åˆ†æ”¯é¢æ¿ -->
    <div class="branch-panel">
        <div class="branch-header">
            <h3>å¯¹è¯åˆ†æ”¯</h3>
        </div>
        <div class="branch-tree" id="branchTree">
            <!-- åˆ†æ”¯èŠ‚ç‚¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="branch-actions">
            <button id="newMainBranch">æ–°å»ºä¸»åˆ†æ”¯</button>
            <button id="mergeBranches">åˆå¹¶åˆ†æ”¯</button>
        </div>
    </div>
    
    <!-- å¯¹è¯é¢æ¿ -->
    <div class="chat-panel">
        <div class="chat-header">
            <h3 id="currentBranchName">ä¸»åˆ†æ”¯</h3>
            <div class="branch-info">
                <span id="branchPath">è·¯å¾„: ä¸»åˆ†æ”¯</span>
            </div>
            <button id="viewFlowGraph" title="æŸ¥çœ‹å¯¹è¯æµç¨‹å›¾">ğŸ“Š</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- å¯¹è¯æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="chat-input">
            <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..."></textarea>
            <button id="sendMessage">å‘é€</button>
        </div>
        
        <!-- æ¶ˆæ¯é€‰æ‹©æ“ä½œæ  -->
        <div class="selection-actions" id="selectionActions">
            <span class="selection-count" id="selectionCount">å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯</span>
            <button class="create-from-selection" id="createFromSelection">åŸºäºé€‰ä¸­å†…å®¹åˆ›å»ºåˆ†æ”¯</button>
            <button class="create-from-selection" id="generateSummary">ç”Ÿæˆæ‘˜è¦</button>
            <button class="clear-selection" id="clearSelection">æ¸…é™¤é€‰æ‹©</button>
        </div>
    </div>
    
    <!-- åˆ†æ”¯åˆ›å»ºé¢æ¿ -->
    <div class="branch-create" id="branchCreatePanel">
        <h3>åˆ›å»ºæ–°åˆ†æ”¯</h3>
        <p>æ–°åˆ†æ”¯å°†ä»é€‰å®šçš„æ¶ˆæ¯å¼€å§‹</p>
        <div class="branch-create-buttons">
            <button class="cancel" id="cancelBranch">å–æ¶ˆ</button>
            <button class="create" id="createBranch">åˆ›å»º</button>
        </div>
    </div>
    

    
    <!-- æµç¨‹å›¾æ¨¡æ€æ¡† -->
    <div class="flow-graph-modal" id="flowGraphModal">
        <div class="flow-graph-container">
            <div class="flow-graph-header">
                <h3>å¯¹è¯æµç¨‹å›¾</h3>
                <button class="flow-graph-close" id="closeFlowGraph">Ã—</button>
            </div>
            <div class="flow-graph-content">
                <svg class="flow-graph-svg" id="flowGraphSvg"></svg>
            </div>
        </div>
    </div>
    
    <!-- æ‘˜è¦æ¨¡æ€æ¡† -->
    <div class="summary-modal" id="summaryModal">
        <h3>ä¼šè¯æ‘˜è¦</h3>
        <div class="summary-content" id="summaryContent"></div>
        <div class="summary-actions">
            <button class="cancel" id="cancelSummary">å…³é—­</button>
            <button class="create-branch" id="createBranchFromSummary">åŸºäºæ‘˜è¦åˆ›å»ºåˆ†æ”¯</button>
        </div>
    </div>
    <div class="merge-panel" id="mergePanel">
        <h3>åˆå¹¶åˆ†æ”¯</h3>
        <p>é€‰æ‹©è¦åˆå¹¶åˆ°å½“å‰åˆ†æ”¯çš„åˆ†æ”¯ï¼š</p>
        <div class="merge-branches" id="mergeBranchesList">
            <!-- å¯åˆå¹¶çš„åˆ†æ”¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="merge-options">
            <h4>åˆå¹¶æ–¹å¼ï¼š</h4>
            <label class="merge-option">
                <input type="radio" name="mergeType" value="migrate" checked>
                <span>è¿ç§»æ‰€æœ‰èŠå¤©æ°”æ³¡ï¼ŒæŒ‰æ—¶é—´é¡ºåºé‡æ’</span>
            </label>
            <label class="merge-option">
                <input type="radio" name="mergeType" value="summary">
                <span>ç”Ÿæˆæ‘˜è¦ï¼Œä½œä¸ºå•ä¸ªæ°”æ³¡æ·»åŠ </span>
            </label>
        </div>
        <div class="branch-create-buttons">
            <button class="cancel" id="cancelMerge">å–æ¶ˆ</button>
            <button class="create" id="confirmMerge">åˆå¹¶</button>
        </div>
    </div>

    <script>
        // å¯¹è¯æ•°æ®ç»“æ„
        let conversationData = {
            branches: {
                'main': {
                    id: 'main',
                    name: 'ä¸»åˆ†æ”¯',
                    messages: [
                        { id: 'm1', role: 'user', content: 'ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£äººå·¥æ™ºèƒ½çš„åŸºæœ¬æ¦‚å¿µã€‚', timestamp: new Date() },
                        { id: 'm2', role: 'ai', content: 'å½“ç„¶ï¼äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œæ—¨åœ¨åˆ›é€ èƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½çš„ä»»åŠ¡çš„æœºå™¨ã€‚', timestamp: new Date() },
                        { id: 'm3', role: 'user', content: 'é‚£ä¹ˆæœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€éƒ¨åˆ†å—ï¼Ÿ', timestamp: new Date() },
                        { id: 'm4', role: 'ai', content: 'æ˜¯çš„ï¼Œæœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦å­é¢†åŸŸï¼Œå®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿåœ¨æ²¡æœ‰æ˜ç¡®ç¼–ç¨‹çš„æƒ…å†µä¸‹å­¦ä¹ å’Œæ”¹è¿›ã€‚', timestamp: new Date() }
                    ],
                    parent: null,
                    children: []
                }
            },
            currentBranch: 'main'
        };
        
        // å­˜å‚¨å½“å‰é€‰ä¸­çš„æ¶ˆæ¯ID
        let selectedMessages = [];

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            renderBranchTree();
            renderCurrentBranch();
            
            // å‘é€æ¶ˆæ¯äº‹ä»¶
            document.getElementById('sendMessage').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // åˆ†æ”¯åˆ›å»ºäº‹ä»¶
            document.getElementById('newMainBranch').addEventListener('click', showBranchCreatePanel);
            document.getElementById('cancelBranch').addEventListener('click', hideBranchCreatePanel);
            document.getElementById('createBranch').addEventListener('click', createNewBranch);
            
            // åˆå¹¶åˆ†æ”¯äº‹ä»¶
            document.getElementById('mergeBranches').addEventListener('click', showMergePanel);
            document.getElementById('cancelMerge').addEventListener('click', hideMergePanel);
            document.getElementById('confirmMerge').addEventListener('click', mergeBranches);
            
            // åŸºäºé€‰ä¸­å†…å®¹åˆ›å»ºåˆ†æ”¯äº‹ä»¶
            document.getElementById('createFromSelection').addEventListener('click', createBranchFromSelection);
            document.getElementById('clearSelection').addEventListener('click', clearMessageSelection);
            document.getElementById('generateSummary').addEventListener('click', generateSummary);
            
            // æµç¨‹å›¾ç›¸å…³äº‹ä»¶
            document.getElementById('viewFlowGraph').addEventListener('click', showFlowGraph);
            document.getElementById('closeFlowGraph').addEventListener('click', hideFlowGraph);
            
            // æ‘˜è¦ç›¸å…³äº‹ä»¶
            document.getElementById('cancelSummary').addEventListener('click', hideSummary);
            document.getElementById('createBranchFromSummary').addEventListener('click', createBranchFromSummary);
        });

        // æ¸²æŸ“åˆ†æ”¯æ ‘
        function renderBranchTree() {
            const branchTree = document.getElementById('branchTree');
            branchTree.innerHTML = '';
            
            // é€’å½’æ¸²æŸ“åˆ†æ”¯
            function renderBranch(branchId, level = 0) {
                const branch = conversationData.branches[branchId];
                const branchNode = document.createElement('div');
                branchNode.className = `branch-node ${conversationData.currentBranch === branchId ? 'active' : ''}`;
                branchNode.style.paddingLeft = `${10 + level * 20}px`;
                branchNode.dataset.branchId = branchId;
                
                branchNode.innerHTML = `
                    <div class="branch-name">${branch.name}</div>
                    <div class="branch-content">${branch.messages[branch.messages.length - 1]?.content.substring(0, 30) || 'ç©ºåˆ†æ”¯'}...</div>
                `;
                
                branchNode.addEventListener('click', () => switchBranch(branchId));
                branchTree.appendChild(branchNode);
                
                // æ¸²æŸ“å­åˆ†æ”¯
                branch.children.forEach(childId => {
                    renderBranch(childId, level + 1);
                });
            }
            
            // ä»æ ¹åˆ†æ”¯å¼€å§‹æ¸²æŸ“
            Object.keys(conversationData.branches).forEach(branchId => {
                if (!conversationData.branches[branchId].parent) {
                    renderBranch(branchId);
                }
            });
        }

        // æ¸²æŸ“å½“å‰åˆ†æ”¯çš„å¯¹è¯
        function renderCurrentBranch() {
            const chatMessages = document.getElementById('chatMessages');
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            chatMessages.innerHTML = '';
            currentBranch.messages.forEach((message, index) => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.role === 'user' ? 'user-message' : message.role === 'ai' ? 'ai-message' : 'system'}`;
                messageElement.dataset.messageId = message.id;
                
                // æ ‡è®°åˆ†æ”¯èµ·å§‹ç‚¹
                if (currentBranch.parent && index === 0) {
                    messageElement.classList.add('branch-start-point');
                }
                
                messageElement.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-actions">
                        <button class="action-btn select-message" title="é€‰æ‹©/å–æ¶ˆé€‰æ‹©æ­¤æ¶ˆæ¯">âœ…</button>
                        <button class="action-btn branch-from-here" title="ä»æ­¤å¤„åˆ›å»ºåˆ†æ”¯(åŒ…å«æ‰€æœ‰å†å²)">ğŸŒ¿</button>
                        <button class="action-btn branch-only-this" title="ä»…ä»¥æ­¤å†…å®¹ä¸ºåŸºç¡€åˆ›å»ºåˆ†æ”¯">âœ‚ï¸</button>
                        <button class="action-btn highlight-keywords" title="æ ‡è®°å…³é”®è¯">ğŸ”–</button>
                    </div>
                `;
                
                // é‡æ–°è®¾ç½®data-message-idå±æ€§ï¼Œç¡®ä¿toggleMessageSelectionèƒ½æ‰¾åˆ°å…ƒç´ 
                messageElement.dataset.messageId = message.id;
                
                chatMessages.appendChild(messageElement);
                
                // æ·»åŠ æ¶ˆæ¯é€‰æ‹©äº‹ä»¶
                messageElement.addEventListener('click', (e) => {
                    // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯æ¶ˆæ¯å†…å®¹åŒºåŸŸæ—¶æ‰è§¦å‘é€‰æ‹©
                    const contentElement = messageElement.querySelector('.message-content');
                    if (e.target === contentElement || contentElement.contains(e.target)) {
                        toggleMessageSelection(message.id);
                    }
                });
                
                // æ·»åŠ å¤šé€‰æŒ‰é’®äº‹ä»¶
                messageElement.querySelector('.select-message').addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMessageSelection(message.id);
                });
                
                // æ·»åŠ åˆ†æ”¯åˆ›å»ºäº‹ä»¶ - ç›´æ¥åˆ›å»ºåˆ†æ”¯è€Œä¸æ˜¾ç¤ºé¢æ¿
                messageElement.querySelector('.branch-from-here').addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // ç›´æ¥åˆ›å»ºåˆ†æ”¯ - åŒ…å«æ‰€æœ‰å†å²æ¶ˆæ¯
                    const newBranchId = 'branch_' + Date.now();
                    const currentBranch = conversationData.branches[conversationData.currentBranch];
                    
                    // ç¡®å®šæ–°åˆ†æ”¯çš„èµ·å§‹æ¶ˆæ¯ç´¢å¼•
                    let startingPoint = 0;
                    if (message.id) {
                        startingPoint = currentBranch.messages.findIndex(m => m.id === message.id);
                    }
                    
                    // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«èµ·å§‹ç‚¹åŠä¹‹å‰çš„æ¶ˆæ¯
                    conversationData.branches[newBranchId] = {
                        id: newBranchId,
                        name: `åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                        messages: [
                            // åªåŒ…å«èµ·å§‹ç‚¹åŠä¹‹å‰çš„æ¶ˆæ¯
                            ...currentBranch.messages.slice(0, startingPoint + 1)
                        ],
                        parent: {
                            branch: conversationData.currentBranch,
                            messageId: message.id
                        },
                        children: []
                    };
                    
                    // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
                    currentBranch.children.push(newBranchId);
                    
                    // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
                    switchBranch(newBranchId);
                });
                
                // æ·»åŠ ä»…ä»¥æ­¤å†…å®¹ä¸ºåŸºç¡€åˆ›å»ºåˆ†æ”¯çš„äº‹ä»¶
                messageElement.querySelector('.branch-only-this').addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // ç›´æ¥åˆ›å»ºåˆ†æ”¯ - ä»…åŒ…å«é€‰ä¸­çš„æ¶ˆæ¯å†…å®¹
                    const newBranchId = 'branch_' + Date.now();
                    const currentBranch = conversationData.branches[conversationData.currentBranch];
                    
                    // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«é€‰ä¸­çš„æ¶ˆæ¯
                    conversationData.branches[newBranchId] = {
                        id: newBranchId,
                        name: `ä»…é€‰åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                        messages: [
                            // ä»…åŒ…å«é€‰ä¸­çš„æ¶ˆæ¯
                            {
                                ...message, // å¤åˆ¶é€‰ä¸­çš„æ¶ˆæ¯å†…å®¹
                                id: 'm' + Date.now() // ç”Ÿæˆæ–°çš„IDä»¥é¿å…å†²çª
                            }
                        ],
                        parent: {
                            branch: conversationData.currentBranch,
                            messageId: message.id
                        },
                        children: []
                    };
                    
                    // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
                    currentBranch.children.push(newBranchId);
                    
                    // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
                    switchBranch(newBranchId);
                });
            });
            
            // æ›´æ–°åˆ†æ”¯ä¿¡æ¯
            document.getElementById('currentBranchName').textContent = currentBranch.name;
            document.getElementById('branchPath').textContent = `è·¯å¾„: ${getBranchPath(currentBranch.id)}`;
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // è·å–åˆ†æ”¯è·¯å¾„
        function getBranchPath(branchId) {
            let path = [];
            let currentBranch = conversationData.branches[branchId];
            
            while (currentBranch) {
                path.unshift(currentBranch.name);
                if (currentBranch.parent) {
                    currentBranch = conversationData.branches[currentBranch.parent.branch];
                } else {
                    currentBranch = null;
                }
            }
            
            return path.join(' â†’ ');
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                const currentBranch = conversationData.branches[conversationData.currentBranch];
                const messageId = 'm' + Date.now();
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                currentBranch.messages.push({
                    id: messageId,
                    role: 'user',
                    content: message,
                    timestamp: new Date()
                });
                
                // æ¨¡æ‹ŸAIå›å¤
                setTimeout(() => {
                    const aiMessageId = 'm' + Date.now();
                    currentBranch.messages.push({
                        id: aiMessageId,
                        role: 'ai',
                        content: generateAIResponse(message, currentBranch.messages),
                        timestamp: new Date()
                    });
                    
                    renderCurrentBranch();
                    renderBranchTree();
                }, 1000);
                
                renderCurrentBranch();
                input.value = '';
            }
        }

        // ç”ŸæˆAIå›å¤ï¼ˆæ¨¡æ‹Ÿï¼‰
        function generateAIResponse(userMessage, messageHistory) {
            const responses = [
                "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚",
                "åŸºäºæˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œæˆ‘è®¤ä¸º...",
                "æ‚¨æåˆ°äº†ä¸€ä¸ªå…³é”®ç‚¹ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘æƒ³è¡¥å……...",
                "æˆ‘ç†è§£æ‚¨çš„ç–‘é—®ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥ä»å¤šä¸ªè§’åº¦æ¥ç†è§£...",
                "æ„Ÿè°¢æ‚¨çš„æé—®ï¼è¿™è®©æˆ‘æƒ³åˆ°äº†ç›¸å…³çš„æ¦‚å¿µ..."
            ];
            
            // ç®€å•æ¨¡æ‹Ÿæ ¹æ®æ¶ˆæ¯å†å²ç”Ÿæˆå›å¤
            if (userMessage.includes('?')) {
                return "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ·±åº¦ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘è®¤ä¸º..." + responses[Math.floor(Math.random() * responses.length)];
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // æ˜¾ç¤ºåˆ†æ”¯åˆ›å»ºé¢æ¿
        function showBranchCreatePanel(fromMessageId = null) {
            const panel = document.getElementById('branchCreatePanel');
            panel.style.display = 'block';
            panel.dataset.fromMessageId = fromMessageId;
            
            // å®šä½é¢æ¿
            if (fromMessageId) {
                const messageElement = document.querySelector(`[data-message-id="${fromMessageId}"]`);
                const rect = messageElement.getBoundingClientRect();
                panel.style.top = `${rect.top}px`;
                panel.style.left = `${rect.right + 10}px`;
            } else {
                panel.style.top = '50%';
                panel.style.left = '50%';
                panel.style.transform = 'translate(-50%, -50%)';
            }
        }

        // éšè—åˆ†æ”¯åˆ›å»ºé¢æ¿
        function hideBranchCreatePanel() {
            document.getElementById('branchCreatePanel').style.display = 'none';
        }

        // åˆ›å»ºæ–°åˆ†æ”¯
        function createNewBranch() {
            const fromMessageId = document.getElementById('branchCreatePanel').dataset.fromMessageId;
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // ç¡®å®šæ–°åˆ†æ”¯çš„èµ·å§‹æ¶ˆæ¯ç´¢å¼•
            let startingPoint = 0;
            if (fromMessageId) {
                startingPoint = currentBranch.messages.findIndex(m => m.id === fromMessageId);
            }
            
            // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«èµ·å§‹ç‚¹åŠä¹‹å‰çš„æ¶ˆæ¯
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                messages: [
                    // åªåŒ…å«èµ·å§‹ç‚¹åŠä¹‹å‰çš„æ¶ˆæ¯
                    ...currentBranch.messages.slice(0, startingPoint + 1)
                ],
                parent: {
                    branch: conversationData.currentBranch,
                    messageId: fromMessageId
                },
                children: []
            };
            
            // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
            currentBranch.children.push(newBranchId);
            
            // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
            switchBranch(newBranchId);
            
            // éšè—é¢æ¿
            hideBranchCreatePanel();
        }

        // åˆ‡æ¢åˆ†æ”¯
        function switchBranch(branchId) {
            conversationData.currentBranch = branchId;
            renderBranchTree();
            renderCurrentBranch();
        }

        // æ˜¾ç¤ºåˆå¹¶åˆ†æ”¯é¢æ¿
        function showMergePanel() {
            const panel = document.getElementById('mergePanel');
            const branchesList = document.getElementById('mergeBranchesList');
            
            branchesList.innerHTML = '';
            
            // æ·»åŠ å¯åˆå¹¶çš„åˆ†æ”¯ï¼ˆæ’é™¤å½“å‰åˆ†æ”¯ï¼‰
            Object.keys(conversationData.branches).forEach(branchId => {
                if (branchId !== conversationData.currentBranch) {
                    const branch = conversationData.branches[branchId];
                    const branchElement = document.createElement('div');
                    branchElement.className = 'merge-branch';
                    branchElement.dataset.branchId = branchId;
                    branchElement.textContent = branch.name;
                    
                    branchElement.addEventListener('click', function() {
                        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('.merge-branch').forEach(el => {
                            el.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    });
                    
                    branchesList.appendChild(branchElement);
                }
            });
            
            panel.style.display = 'block';
            panel.style.top = '50%';
            panel.style.left = '50%';
            panel.style.transform = 'translate(-50%, -50%)';
        }

        // éšè—åˆå¹¶åˆ†æ”¯é¢æ¿
        function hideMergePanel() {
            document.getElementById('mergePanel').style.display = 'none';
        }

        // ç”Ÿæˆä¼šè¯æ‘˜è¦
        function generateConversationSummary(messages) {
            // ç®€å•å®ç°ï¼šæå–å…³é”®ä¿¡æ¯å’Œä¸»è¦é—®é¢˜
            const userMessages = messages.filter(m => m.role === 'user');
            const aiResponses = messages.filter(m => m.role === 'ai');
            
            // æå–å…³é”®è¯
            let keywords = [];
            userMessages.forEach(msg => {
                // ç®€å•çš„å…³é”®è¯æå–é€»è¾‘
                const words = msg.content.toLowerCase().split(/\s+/);
                const importantWords = words.filter(word => 
                    word.length > 3 && 
                    !['the', 'and', 'but', 'or', 'because', 'so', 'is', 'are', 'was', 'were'].includes(word)
                );
                keywords = [...keywords, ...importantWords];
            });
            
            // ç»Ÿè®¡å…³é”®è¯é¢‘ç‡
            const keywordFreq = {};
            keywords.forEach(keyword => {
                keywordFreq[keyword] = (keywordFreq[keyword] || 0) + 1;
            });
            
            // å–æœ€é¢‘ç¹çš„5ä¸ªå…³é”®è¯
            const topKeywords = Object.entries(keywordFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => entry[0])
                .join(', ');
            
            // ç”Ÿæˆæ‘˜è¦
            return `[åˆ†æ”¯"${conversationData.branches[conversationData.currentBranch].name}"çš„å¯¹è¯æ‘˜è¦]\n\n` +
                   `è¿™æ˜¯ä¸€ä¸ªåŒ…å«${userMessages.length}ä¸ªç”¨æˆ·æé—®å’Œ${aiResponses.length}ä¸ªAIå›å¤çš„å¯¹è¯ã€‚\n\n` +
                   `ä¸»è¦è®¨è®ºå†…å®¹å›´ç»•ï¼š${topKeywords}\n\n` +
                   `ç”¨æˆ·çš„ä¸»è¦é—®é¢˜æ˜¯ï¼š${userMessages.length > 0 ? userMessages[0].content.substring(0, 100) + '...' : 'æ— '}`;
        }
        
        // åˆå¹¶åˆ†æ”¯
        function mergeBranches() {
            const selectedBranch = document.querySelector('.merge-branch.selected');
            
            if (selectedBranch) {
                const branchId = selectedBranch.dataset.branchId;
                const currentBranch = conversationData.branches[conversationData.currentBranch];
                const branchToMerge = conversationData.branches[branchId];
                
                // è·å–ç”¨æˆ·é€‰æ‹©çš„åˆå¹¶æ–¹å¼
                const mergeType = document.querySelector('input[name="mergeType"]:checked').value;
                
                if (mergeType === 'migrate') {
                    // æ–¹å¼1ï¼šè¿ç§»æ‰€æœ‰èŠå¤©æ°”æ³¡ï¼ŒæŒ‰æ—¶é—´é¡ºåºé‡æ’
                    // å¤åˆ¶æ‰€æœ‰æ¶ˆæ¯å¹¶ç”Ÿæˆæ–°çš„ID
                    const migratedMessages = branchToMerge.messages.map(msg => ({
                        ...msg,
                        id: 'm' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date(msg.timestamp) // ä¿æŒåŸå§‹æ—¶é—´æˆ³
                    }));
                    
                    // åˆå¹¶å¹¶æŒ‰æ—¶é—´æ’åº
                    currentBranch.messages = [...currentBranch.messages, ...migratedMessages]
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                } else if (mergeType === 'summary') {
                    // æ–¹å¼2ï¼šç”Ÿæˆæ‘˜è¦ï¼Œä½œä¸ºå•ä¸ªæ°”æ³¡æ·»åŠ 
                    const summary = generateConversationSummary(branchToMerge.messages);
                    
                    currentBranch.messages.push({
                        id: 'm' + Date.now(),
                        role: 'system',
                        content: `[æ¥è‡ªåˆ†æ”¯"${branchToMerge.name}"çš„æ‘˜è¦]\n\n${summary}`,
                        timestamp: new Date()
                    });
                }
                
                renderCurrentBranch();
                renderBranchTree();
                hideMergePanel();
            }
        }
        
        // åˆ‡æ¢æ¶ˆæ¯é€‰æ‹©çŠ¶æ€
        function toggleMessageSelection(messageId) {
            const index = selectedMessages.indexOf(messageId);
            
            if (index > -1) {
                // å–æ¶ˆé€‰æ‹©
                selectedMessages.splice(index, 1);
                document.querySelector(`[data-message-id="${messageId}"]`).classList.remove('selected');
            } else {
                // é€‰æ‹©æ¶ˆæ¯
                selectedMessages.push(messageId);
                document.querySelector(`[data-message-id="${messageId}"]`).classList.add('selected');
            }
            
            updateSelectionUI();
        }
        
        // æ›´æ–°é€‰æ‹©UI
        function updateSelectionUI() {
            const selectionCount = document.getElementById('selectionCount');
            const selectionActions = document.getElementById('selectionActions');
            
            selectionCount.textContent = `å·²é€‰æ‹© ${selectedMessages.length} æ¡æ¶ˆæ¯`;
            
            if (selectedMessages.length > 0) {
                selectionActions.style.display = 'flex';
            } else {
                selectionActions.style.display = 'none';
            }
        }
        
        // æ¸…é™¤æ¶ˆæ¯é€‰æ‹©
        function clearMessageSelection() {
            selectedMessages.forEach(messageId => {
                document.querySelector(`[data-message-id="${messageId}"]`).classList.remove('selected');
            });
            
            selectedMessages = [];
            updateSelectionUI();
        }
        
        // åŸºäºé€‰ä¸­å†…å®¹åˆ›å»ºåˆ†æ”¯
        function createBranchFromSelection() {
            if (selectedMessages.length === 0) {
                return;
            }
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // è·å–é€‰ä¸­çš„æ¶ˆæ¯å¹¶ä¿æŒé¡ºåº
            const selectedMessagesData = selectedMessages
                .map(messageId => {
                    const message = currentBranch.messages.find(m => m.id === messageId);
                    return message ? { ...message, id: 'm' + Date.now() + '_' + messageId } : null;
                })
                .filter(Boolean);
            
            // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«é€‰ä¸­çš„æ¶ˆæ¯
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `å¤šé€‰åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                messages: selectedMessagesData,
                parent: {
                    branch: conversationData.currentBranch,
                    messageIds: [...selectedMessages] // ä¿å­˜æ‰€æœ‰é€‰ä¸­çš„æ¶ˆæ¯IDç”¨äºå¼•ç”¨
                },
                children: []
            };
            
            // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
            currentBranch.children.push(newBranchId);
            
            // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
            switchBranch(newBranchId);
            
            // æ¸…é™¤é€‰æ‹©
            clearMessageSelection();
        }
        
        // æ˜¾ç¤ºæµç¨‹å›¾
        function showFlowGraph() {
            const modal = document.getElementById('flowGraphModal');
            modal.style.display = 'flex';
            drawFlowGraph();
        }
        
        // éšè—æµç¨‹å›¾
        function hideFlowGraph() {
            document.getElementById('flowGraphModal').style.display = 'none';
        }
        
        // ç»˜åˆ¶æµç¨‹å›¾
        function drawFlowGraph() {
            const svg = document.getElementById('flowGraphSvg');
            svg.innerHTML = '';
            
            // è·å–SVGå°ºå¯¸
            const width = svg.clientWidth;
            const height = svg.clientHeight;
            
            // è®¾ç½®SVGå±æ€§
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            
            // è®¡ç®—èŠ‚ç‚¹ä½ç½®çš„ç®€å•å¸ƒå±€ç®—æ³•
            const nodes = {};
            const edges = [];
            const nodeSize = 80;
            const horizontalSpacing = 200;
            const verticalSpacing = 100;
            
            // è®¡ç®—å±‚æ¬¡ç»“æ„
            const levels = {};
            const rootBranches = [];
            
            // æ‰¾åˆ°æ ¹åˆ†æ”¯
            Object.keys(conversationData.branches).forEach(branchId => {
                if (!conversationData.branches[branchId].parent) {
                    rootBranches.push(branchId);
                }
            });
            
            // åˆ†é…èŠ‚ç‚¹ä½ç½®
            function assignPositions(branchId, level = 0, position = 0) {
                if (!levels[level]) {
                    levels[level] = 0;
                }
                
                const actualPosition = levels[level]++;
                const x = 100 + level * horizontalSpacing;
                const y = 100 + actualPosition * verticalSpacing;
                
                nodes[branchId] = { x, y };
                
                // å¤„ç†å­åˆ†æ”¯
                const branch = conversationData.branches[branchId];
                branch.children.forEach((childId, idx) => {
                    edges.push({ from: branchId, to: childId });
                    assignPositions(childId, level + 1, idx);
                });
            }
            
            // ä»æ ¹åˆ†æ”¯å¼€å§‹åˆ†é…ä½ç½®
            rootBranches.forEach((branchId, idx) => {
                assignPositions(branchId);
            });
            
            // ç»˜åˆ¶è¿æ¥çº¿
            edges.forEach(edge => {
                const from = nodes[edge.from];
                const to = nodes[edge.to];
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                line.classList.add('graph-edge');
                
                // ç®€å•çš„è´å¡å°”æ›²çº¿è¿æ¥
                const path = `M ${from.x + nodeSize/2} ${from.y + nodeSize/2} C ${(from.x + to.x)/2} ${from.y + nodeSize/2}, ${(from.x + to.x)/2} ${to.y + nodeSize/2}, ${to.x - nodeSize/2} ${to.y + nodeSize/2}`;
                line.setAttribute('d', path);
                svg.appendChild(line);
            });
            
            // ç»˜åˆ¶èŠ‚ç‚¹
            Object.keys(nodes).forEach(branchId => {
                const node = nodes[branchId];
                const branch = conversationData.branches[branchId];
                const isActive = branchId === conversationData.currentBranch;
                
                const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                nodeGroup.classList.add('graph-node');
                if (isActive) {
                    nodeGroup.classList.add('active');
                }
                
                // èŠ‚ç‚¹åœ†
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', node.x + nodeSize/2);
                circle.setAttribute('cy', node.y + nodeSize/2);
                circle.setAttribute('r', nodeSize/2);
                circle.setAttribute('fill', branch.parent ? '#f0f0f0' : 'var(--user-bubble)');
                
                // èŠ‚ç‚¹æ–‡æœ¬
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', node.x + nodeSize/2);
                text.setAttribute('y', node.y + nodeSize/2);
                text.setAttribute('dy', '0.3em');
                
                // æˆªæ–­é•¿æ–‡æœ¬
                const shortName = branch.name.length > 8 ? branch.name.substring(0, 8) + '...' : branch.name;
                text.textContent = shortName;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                nodeGroup.addEventListener('click', () => {
                    hideFlowGraph();
                    switchBranch(branchId);
                });
                
                nodeGroup.appendChild(circle);
                nodeGroup.appendChild(text);
                svg.appendChild(nodeGroup);
            })
          
        }
        
        // ç”Ÿæˆæ‘˜è¦
        function generateSummary() {
            if (selectedMessages.length === 0) {
                return;
            }
            
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // è·å–é€‰ä¸­çš„æ¶ˆæ¯å¹¶ä¿æŒé¡ºåº
            const selectedMessagesData = currentBranch.messages
                .filter(message => selectedMessages.includes(message.id))
                .sort((a, b) => currentBranch.messages.indexOf(a) - currentBranch.messages.indexOf(b));
            
            // ç®€å•çš„æ‘˜è¦ç”Ÿæˆé€»è¾‘
            let summary = "";
            
            // ç»Ÿè®¡ç”¨æˆ·å’ŒAIçš„å‘è¨€æ¬¡æ•°
            const userMessages = selectedMessagesData.filter(m => m.role === 'user');
            const aiMessages = selectedMessagesData.filter(m => m.role === 'ai');
            
            // æå–å…³é”®è¯ï¼ˆç®€å•å®ç°ï¼‰
            const keywords = extractKeywords(selectedMessagesData.map(m => m.content).join(' '));
            
            // ç”Ÿæˆæ‘˜è¦æ–‡æœ¬
            summary += `è¿™æ®µå¯¹è¯åŒ…å« ${userMessages.length} æ¡ç”¨æˆ·æ¶ˆæ¯å’Œ ${aiMessages.length} æ¡AIå›å¤ã€‚\n\n`;
            
            if (keywords.length > 0) {
                summary += `è®¨è®ºçš„ä¸»è¦å…³é”®è¯ï¼š${keywords.join(', ')}\n\n`;
            }
            
            // æå–ç”¨æˆ·çš„ä¸»è¦é—®é¢˜
            if (userMessages.length > 0) {
                summary += "ç”¨æˆ·çš„ä¸»è¦é—®é¢˜/å…³æ³¨ç‚¹ï¼š\n";
                userMessages.forEach((msg, idx) => {
                    // åªæ˜¾ç¤ºä¸å¤ªé•¿çš„æ¶ˆæ¯
                    const shortContent = msg.content.length > 80 ? msg.content.substring(0, 80) + '...' : msg.content;
                    summary += `- ${shortContent}\n`;
                });
            }
            
            // æ›´æ–°æ‘˜è¦å†…å®¹
            document.getElementById('summaryContent').textContent = summary;
            
            // æ˜¾ç¤ºæ‘˜è¦æ¨¡æ€æ¡†
            document.getElementById('summaryModal').style.display = 'block';
        }
        
        // ç®€å•çš„å…³é”®è¯æå–å‡½æ•°
        function extractKeywords(text) {
            // ç§»é™¤å¸¸è§åœç”¨è¯
            const stopwords = ['çš„', 'äº†', 'åœ¨', 'æ˜¯', 'æˆ‘', 'æœ‰', 'å’Œ', 'å°±', 'ä¸', 'äºº', 'éƒ½', 'ä¸€', 'ä¸€ä¸ª', 'ä¸Š', 'ä¹Ÿ', 'å¾ˆ', 'åˆ°', 'è¯´', 'è¦', 'å»', 'ä½ ', 'ä¼š', 'ç€', 'æ²¡æœ‰', 'çœ‹', 'å¥½', 'è‡ªå·±', 'è¿™'];
            
            // åˆ†è¯å¹¶è¿‡æ»¤
            const words = text
                .replace(/[.,?!;:"â€œâ€â€˜â€™()\[\]{}]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 1 && !stopwords.includes(word))
                .map(word => word.toLowerCase());
            
            // ç»Ÿè®¡è¯é¢‘
            const wordCounts = {};
            words.forEach(word => {
                wordCounts[word] = (wordCounts[word] || 0) + 1;
            });
            
            // æ’åºå¹¶è¿”å›å‰5ä¸ªå…³é”®è¯
            return Object.keys(wordCounts)
                .sort((a, b) => wordCounts[b] - wordCounts[a])
                .slice(0, 5);
        }
        
        // éšè—æ‘˜è¦
        function hideSummary() {
            document.getElementById('summaryModal').style.display = 'none';
        }
        
        // åŸºäºæ‘˜è¦åˆ›å»ºåˆ†æ”¯
        function createBranchFromSummary() {
            const summary = document.getElementById('summaryContent').textContent;
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«æ‘˜è¦æ¶ˆæ¯
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `æ‘˜è¦åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                messages: [
                    {
                        id: 'm' + Date.now(),
                        role: 'user',
                        content: 'åŸºäºä»¥ä¸‹æ‘˜è¦ç»§ç»­è®¨è®ºï¼š\n' + summary,
                        timestamp: new Date()
                    }
                ],
                parent: {
                    branch: conversationData.currentBranch,
                    summaryBased: true,
                    messageIds: [...selectedMessages] // ä¿å­˜æ‰€æœ‰é€‰ä¸­çš„æ¶ˆæ¯IDç”¨äºå¼•ç”¨
                },
                children: []
            };
            
            // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
            currentBranch.children.push(newBranchId);
            
            // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
            switchBranch(newBranchId);
            
            // éšè—æ‘˜è¦æ¨¡æ€æ¡†
            hideSummary();
            
            // æ¸…é™¤é€‰æ‹©
            clearMessageSelection();
        }
    </script>
</body>
</html>