<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ”¯å¼AIå¯¹è¯ç•Œé¢</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --user-bubble: #e3f2fd;
            --ai-bubble: #f5f5f5;
            --branch-color: #8bc34a;
            --border-color: #ddd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --selected-bg: rgba(74, 111, 165, 0.1);
            --selected-border: #4a6fa5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            height: 100vh;
            background-color: #f9f9f9;
        }
        
        /* åˆ†æ”¯é¢æ¿æ ·å¼ */
        .branch-panel {
            width: 280px;
            background-color: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .branch-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .branch-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .branch-node {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            border-left: 3px solid transparent;
        }
        
        .branch-node.active {
            background-color: var(--user-bubble);
            border-left-color: var(--primary-color);
        }
        
        .branch-node:hover {
            background-color: #f0f0f0;
        }
        
        .branch-content {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .branch-actions {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        /* å¯¹è¯é¢æ¿æ ·å¼ */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }
        
        .chat-header {
            padding: 15px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .message.selected {
            background-color: var(--selected-bg);
            border: 2px solid var(--selected-border);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background-color: var(--user-bubble);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message {
            background-color: var(--ai-bubble);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            display: none;
            padding: 5px;
        }
        
        .message:hover .message-actions {
            display: flex;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            margin: 0 2px;
            color: #666;
        }
        
        .action-btn:hover {
            background-color: #f0f0f0;
            color: var(--primary-color);
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
        }
        
        .chat-input textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            height: 60px;
        }
        
        .chat-input button {
            margin-left: 10px;
            padding: 0 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .branch-indicator {
            font-size: 0.8em;
            color: var(--branch-color);
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        
        .branch-indicator::before {
            content: "â€¢";
            margin-right: 5px;
            color: var(--branch-color);
        }
        
        /* åˆ†æ”¯åˆ›å»ºé¢æ¿ */
        .branch-create {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            z-index: 100;
            width: 300px;
            display: none;
        }
        
        .branch-create h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .branch-create textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            margin-bottom: 10px;
        }
        
        .branch-create-buttons {
            display: flex;
            justify-content: flex-end;
        }
        
        .branch-create-buttons button {
            margin-left: 10px;
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .branch-create-buttons .cancel {
            background-color: #f5f5f5;
        }
        
        .branch-create-buttons .create {
            background-color: var(--branch-color);
            color: white;
        }
        
        /* åˆå¹¶åˆ†æ”¯é¢æ¿ */
        .merge-panel {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            z-index: 100;
            width: 350px;
            display: none;
        }
        
        .merge-branches {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .merge-branch {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .merge-branch.selected {
            border-color: var(--branch-color);
            background-color: rgba(139, 195, 74, 0.1);
        }
        
        /* åˆå¹¶é€‰é¡¹æ ·å¼ */
        .merge-options {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .merge-options h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
        
        .merge-option {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
        }
        
        .merge-option input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .merge-option span {
            font-size: 13px;
            color: #555;
            cursor: pointer;
        }
        
        /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
        .message.system {
            background-color: #fff9c4;
            border-left: 4px solid #ffc107;
        }
        
        .branch-start-point {
            background-color: rgba(139, 195, 74, 0.1);
            border-left: 3px solid var(--branch-color);
        }
        
        /* é€‰æ‹©è®¡æ•°å’Œæ“ä½œæ  */
        .selection-actions {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 25px;
            box-shadow: var(--shadow);
            padding: 10px 20px;
            display: none;
            z-index: 1000;
            gap: 15px;
            align-items: center;
        }
        
        .selection-count {
            font-size: 14px;
            color: #666;
        }
        
        .create-from-selection,
        .clear-selection {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-selection {
            background-color: #666;
        }
        
        .create-from-selection:hover {
            background-color: #2980b9;
        }
        
        .clear-selection:hover {
            background-color: #444;
        }
        
        /* é€‰ä¸­çš„æ¶ˆæ¯æ ·å¼ */
        .message.selected {
            background-color: rgba(139, 195, 74, 0.2);
            border-left: 4px solid var(--branch-color);
        }
        
        /* æµç¨‹å›¾æ ·å¼ */
        .flow-graph-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .flow-graph-container {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .flow-graph-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-graph-header h3 {
            color: var(--primary-color);
        }
        
        .flow-graph-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .flow-graph-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .flow-graph-svg {
            width: 100%;
            height: 100%;
            background-color: #f9f9f9;
        }
        
        .graph-node {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .graph-node:hover {
            transform: scale(1.05);
        }
        
        .graph-node circle {
            stroke: var(--border-color);
            stroke-width: 2;
        }
        
        .graph-node text {
            font-size: 12px;
            pointer-events: none;
            text-anchor: middle;
        }
        
        .graph-edge {
            stroke: var(--border-color);
            stroke-width: 2;
            fill: none;
        }
        
        .graph-node.active circle {
            stroke: var(--primary-color);
            stroke-width: 3;
        }
        
        .summary-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 500px;
            max-width: 90%;
            display: none;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .summary-modal h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .summary-content {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            min-height: 100px;
            margin-bottom: 15px;
        }
        
        .summary-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .summary-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .summary-actions .cancel {
            background-color: #f5f5f5;
        }
        
        .summary-actions .create-branch {
            background-color: var(--branch-color);
            color: white;
        }
        
        /* å†…å®¹æ ‡è®°æ ·å¼ */
        .message.content-marked {
            border-left: 4px solid #ffc107;
            background-color: rgba(255, 193, 7, 0.05);
        }
        
        .action-btn.mark-content {
            font-size: 14px;
        }
        
        /* å·²æ ‡è®°å†…å®¹æ¨¡æ€æ¡† */
        .marked-contents-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .marked-contents-container {
            background-color: white;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .marked-contents-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .marked-contents-header h3 {
            color: var(--primary-color);
            margin: 0;
        }
        
        .marked-contents-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .marked-contents-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .marked-content-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .marked-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .marked-content-type {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .marked-content-date {
            font-size: 12px;
            color: #666;
        }
        
        .delete-marked {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        
        .marked-content-body {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        /* æç¤ºæ¶ˆæ¯æ ·å¼ */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 3000;
        }
        
        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- åˆ†æ”¯é¢æ¿ -->
    <div class="branch-panel">
        <div class="branch-header">
            <h3>å¯¹è¯åˆ†æ”¯</h3>
        </div>
        <div class="branch-tree" id="branchTree">
            <!-- åˆ†æ”¯èŠ‚ç‚¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="branch-actions">
            <button id="newMainBranch">æ–°å»ºä¸»åˆ†æ”¯</button>
            <button id="mergeBranches">åˆå¹¶åˆ†æ”¯</button>
        </div>
    </div>
    
    <!-- å¯¹è¯é¢æ¿ -->
    <div class="chat-panel">
        <div class="chat-header">
            <h3 id="currentBranchName">ä¸»åˆ†æ”¯</h3>
            <div class="branch-info">
                <span id="branchPath">è·¯å¾„: ä¸»åˆ†æ”¯</span>
            </div>
            <button id="viewFlowGraph" title="æŸ¥çœ‹å¯¹è¯æµç¨‹å›¾">ğŸ“Š</button>
            <button id="showMarkedContents" title="æŸ¥çœ‹å·²æ ‡è®°å†…å®¹">â­</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- å¯¹è¯æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="chat-input">
            <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..."></textarea>
            <button id="sendMessage">å‘é€</button>
        </div>
        
        <!-- æ¶ˆæ¯é€‰æ‹©æ“ä½œæ  -->
        <div class="selection-actions" id="selectionActions">
            <span class="selection-count" id="selectionCount">å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯</span>
            <button class="create-from-selection" id="createFromSelection">åŸºäºé€‰ä¸­å†…å®¹åˆ›å»ºåˆ†æ”¯</button>
            <button class="create-from-selection" id="generateSummary">ç”Ÿæˆæ‘˜è¦</button>
            <button class="clear-selection" id="clearSelection">æ¸…é™¤é€‰æ‹©</button>
        </div>
    </div>
    
    <!-- åˆ†æ”¯åˆ›å»ºé¢æ¿ -->
    <div class="branch-create" id="branchCreatePanel">
        <h3>åˆ›å»ºæ–°åˆ†æ”¯</h3>
        <p>æ–°åˆ†æ”¯å°†ä»é€‰å®šçš„æ¶ˆæ¯å¼€å§‹</p>
        <div class="branch-create-buttons">
            <button class="cancel" id="cancelBranch">å–æ¶ˆ</button>
            <button class="create" id="createBranch">åˆ›å»º</button>
        </div>
    </div>
    

    
    <!-- æµç¨‹å›¾æ¨¡æ€æ¡† -->
    <div class="flow-graph-modal" id="flowGraphModal">
        <div class="flow-graph-container">
            <div class="flow-graph-header">
                <h3>å¯¹è¯æµç¨‹å›¾</h3>
                <button class="flow-graph-close" id="closeFlowGraph">Ã—</button>
            </div>
            <div class="flow-graph-content">
                <svg class="flow-graph-svg" id="flowGraphSvg"></svg>
            </div>
        </div>
    </div>
    
    <!-- æ‘˜è¦æ¨¡æ€æ¡† -->
    <div class="summary-modal" id="summaryModal">
        <h3>ä¼šè¯æ‘˜è¦</h3>
        <div class="summary-content" id="summaryContent"></div>
        <div class="summary-actions">
            <button class="cancel" id="cancelSummary">å…³é—­</button>
            <button class="create-branch" id="createBranchFromSummary">åŸºäºæ‘˜è¦åˆ›å»ºåˆ†æ”¯</button>
        </div>
    </div>
    
    <!-- å·²æ ‡è®°å†…å®¹æ¨¡æ€æ¡† -->
    <div class="marked-contents-modal" id="markedContentsModal">
        <div class="marked-contents-container">
            <div class="marked-contents-header">
                <h3>å·²æ ‡è®°å†…å®¹</h3>
                <button class="marked-contents-close" id="closeMarkedContents">Ã—</button>
            </div>
            <div class="marked-contents-body">
                <div id="markedContentsList"></div>
            </div>
        </div>
    </div>
    <div class="merge-panel" id="mergePanel">
        <h3>åˆå¹¶åˆ†æ”¯</h3>
        <p>é€‰æ‹©è¦åˆå¹¶åˆ°å½“å‰åˆ†æ”¯çš„åˆ†æ”¯ï¼š</p>
        <div class="merge-branches" id="mergeBranchesList">
            <!-- å¯åˆå¹¶çš„åˆ†æ”¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="merge-options">
            <h4>åˆå¹¶æ–¹å¼ï¼š</h4>
            <label class="merge-option">
                <input type="radio" name="mergeType" value="migrate" checked>
                <span>è¿ç§»æ‰€æœ‰èŠå¤©æ°”æ³¡ï¼ŒæŒ‰æ—¶é—´é¡ºåºé‡æ’</span>
            </label>
            <label class="merge-option">
                <input type="radio" name="mergeType" value="summary">
                <span>ç”Ÿæˆæ‘˜è¦ï¼Œä½œä¸ºå•ä¸ªæ°”æ³¡æ·»åŠ </span>
            </label>
        </div>
        <div class="branch-create-buttons">
            <button class="cancel" id="cancelMerge">å–æ¶ˆ</button>
            <button class="create" id="confirmMerge">åˆå¹¶</button>
        </div>
    </div>

    <style>
        /* æ¨¡å‹é€‰æ‹©ç›¸å…³æ ·å¼ */
        .model-switch-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            min-width: 300px;
            display: none;
        }
        
        .model-switch-panel h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
        }
        
        .model-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .model-option:hover {
            background-color: #f5f5f5;
        }
        
        .model-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .model-switch-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .model-switch-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .model-switch-buttons .cancel {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .model-switch-buttons .confirm {
            background-color: var(--primary-color);
            color: white;
        }
        
        .model-name {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
            font-style: italic;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        
        /* æ¨¡å‹æ ‡ç­¾æ ·å¼ */
        .model-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            background-color: #f0f0f0;
            color: #666;
        }
    </style>
    
    <div id="modalOverlay" class="modal-overlay"></div>
    
    <!-- æ¨¡å‹åˆ‡æ¢é¢æ¿ -->
    <div id="modelSwitchPanel" class="model-switch-panel">
        <h3>åˆ‡æ¢AIæ¨¡å‹</h3>
        <div class="model-options">
            <label class="model-option">
                <input type="radio" name="modelType" value="default" checked>
                <div>
                    <span>é€šç”¨åŠ©æ‰‹</span>
                    <div class="model-name">å¹³è¡¡çš„é€šç”¨å¯¹è¯æ¨¡å‹</div>
                </div>
            </label>
            <label class="model-option">
                <input type="radio" name="modelType" value="technical">
                <div>
                    <span>æŠ€æœ¯ä¸“å®¶</span>
                    <div class="model-name">ä¸“æ³¨äºæŠ€æœ¯é—®é¢˜çš„æ¨¡å‹</div>
                </div>
            </label>
            <label class="model-option">
                <input type="radio" name="modelType" value="creative">
                <div>
                    <span>åˆ›æ„ç”Ÿæˆå™¨</span>
                    <div class="model-name">æ“…é•¿åˆ›æ„å†…å®¹ç”Ÿæˆçš„æ¨¡å‹</div>
                </div>
            </label>
            <label class="model-option">
                <input type="radio" name="modelType" value="simplifier">
                <div>
                    <span>ç®€åŒ–è§£é‡Šå¸ˆ</span>
                    <div class="model-name">æ“…é•¿ç”¨ç®€å•è¯­è¨€è§£é‡Šå¤æ‚æ¦‚å¿µçš„æ¨¡å‹</div>
                </div>
            </label>
        </div>
        <div class="model-switch-buttons">
            <button class="cancel" onclick="hideModelSwitchPanel()">å–æ¶ˆ</button>
            <button class="confirm" onclick="switchAIModel()">åˆ‡æ¢</button>
        </div>
    </div>
    
    <script>
        // å¯¹è¯æ•°æ®ç»“æ„ - å°è¯´åˆ›ä½œä¸»é¢˜
        let conversationData = {
            branches: {
                'main': {
                    id: 'main',
                    name: 'å°è¯´å¤§çº²',
                    messages: [
                        { id: 'm1', role: 'user', content: 'æˆ‘æƒ³å†™ä¸€éƒ¨ç§‘å¹»å°è¯´ï¼Œä½ èƒ½å¸®æˆ‘æ„æ€å¤§çº²å—ï¼Ÿ', timestamp: new Date() },
                        { id: 'm2', role: 'ai', content: 'å½“ç„¶å¯ä»¥ï¼ç§‘å¹»å°è¯´çš„å¤§çº²é€šå¸¸åŒ…å«ä»¥ä¸‹å…ƒç´ ï¼šè®¾å®šèƒŒæ™¯ã€ä¸»è¦äººç‰©ã€æ ¸å¿ƒå†²çªã€æƒ…èŠ‚å‘å±•å’Œç»“å±€ã€‚æˆ‘ä»¬å¯ä»¥ä¸€æ­¥æ­¥æ¥æ„å»ºã€‚é¦–å…ˆï¼Œä½ å¯¹æ•…äº‹èƒŒæ™¯æœ‰ä»€ä¹ˆåˆæ­¥æƒ³æ³•å—ï¼Ÿæ¯”å¦‚æœªæ¥çš„æ—¶é—´ç‚¹ã€ä¸»è¦åœºæ™¯ã€ç§‘æŠ€å‘å±•æ°´å¹³ç­‰ã€‚', timestamp: new Date(), model: 'creative' },
                        { id: 'm3', role: 'user', content: 'æˆ‘æƒ³è®¾å®šåœ¨2150å¹´ï¼Œäººç±»å·²ç»å¼€å§‹æ®–æ°‘ç«æ˜Ÿï¼Œä½†åœ°çƒé¢ä¸´ç€ä¸¥é‡çš„ç¯å¢ƒé—®é¢˜ã€‚ä¸»è¦åœºæ™¯å¯ä»¥åœ¨ç«æ˜Ÿæ®–æ°‘åœ°å’Œåœ°çƒä¹‹é—´åˆ‡æ¢ã€‚', timestamp: new Date() },
                        { id: 'm4', role: 'ai', content: 'è¿™æ˜¯ä¸ªå¾ˆæ£’çš„è®¾å®šï¼ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­æ„æ€ä¸»è¦äººç‰©å’Œæ ¸å¿ƒå†²çªã€‚ä½ å¸Œæœ›æ•…äº‹å›´ç»•æ€æ ·çš„äººç‰©å±•å¼€ï¼Ÿå¯èƒ½çš„æ ¸å¿ƒå†²çªæ˜¯ä»€ä¹ˆï¼Ÿ', timestamp: new Date(), model: 'creative' },
                        { id: 'm5', role: 'user', content: 'ä¸»è§’å¯ä»¥æ˜¯ä¸€åç«æ˜Ÿæ®–æ°‘åœ°çš„å·¥ç¨‹å¸ˆï¼Œä»–å‘ç°äº†ä¸€ä¸ªå¯èƒ½æ”¹å˜äººç±»å‘½è¿çš„ç§‘å­¦çªç ´ï¼Œä½†è¿™ä¸ªçªç ´åŒæ—¶ä¹Ÿå¸¦æ¥äº†å·¨å¤§çš„ä¼¦ç†äº‰è®®ã€‚ä»–å¿…é¡»åœ¨ä¸ªäººç†æƒ³å’Œäººç±»ç¦ç¥‰ä¹‹é—´åšå‡ºæŠ‰æ‹©ã€‚', timestamp: new Date() },
                        { id: 'm6', role: 'ai', content: 'éå¸¸å¼•äººå…¥èƒœçš„è®¾å®šï¼è®©æˆ‘ä»¬æ•´ç†ä¸€ä¸‹ç›®å‰çš„å°è¯´å¤§çº²ï¼š\n\n**å°è¯´æ ‡é¢˜ï¼š** æ˜Ÿé™…æŠ‰æ‹©\n\n**èƒŒæ™¯è®¾å®šï¼š** 2150å¹´ï¼Œäººç±»å·²åœ¨ç«æ˜Ÿå»ºç«‹æ®–æ°‘åœ°ï¼Œåœ°çƒç¯å¢ƒæ¶åŒ–ä¸¥é‡ã€‚\n\n**ä¸»è¦äººç‰©ï¼š**\n- ææ˜Ÿè¾°ï¼š32å²ï¼Œç«æ˜Ÿæ®–æ°‘åœ°çš„é¦–å¸­å·¥ç¨‹å¸ˆï¼Œèªæ˜ã€ç†æƒ³ä¸»ä¹‰ï¼Œä½†æœ‰æ—¶è¿‡äºæ‰§ç€ã€‚\n- å¼ é›¨æ™´ï¼š28å²ï¼Œåœ°çƒç¯å¢ƒç§‘å­¦å®¶ï¼Œææ˜Ÿè¾°çš„å‰å¥³å‹ï¼ŒåšæŒç¯å¢ƒä¿æŠ¤ç†å¿µã€‚\n- é©¬åº“æ–¯ï¼š45å²ï¼Œç«æ˜Ÿæ®–æ°‘åœ°æ€»ç£ï¼ŒåŠ¡å®æ´¾ï¼Œå…³æ³¨æ®–æ°‘åœ°çš„ç”Ÿå­˜ä¸å‘å±•ã€‚\n\n**æ ¸å¿ƒå†²çªï¼š** ææ˜Ÿè¾°å‘ç°äº†ä¸€ç§èƒ½å¤Ÿå¤§å¹…æé«˜ç²®é£Ÿäº§é‡çš„åŸºå› æŠ€æœ¯ï¼Œä½†è¿™é¡¹æŠ€æœ¯å¯èƒ½å¯¹ç”Ÿæ€ç³»ç»Ÿé€ æˆæœªçŸ¥çš„é•¿æœŸå½±å“ã€‚ä»–å¿…é¡»åœ¨æŠ€æœ¯è¿›æ­¥å’Œç¯å¢ƒä¿æŠ¤ä¹‹é—´åšå‡ºæŠ‰æ‹©ã€‚\n\n**æƒ…èŠ‚å‘å±•ï¼š**\n1. å¼€åœºï¼šç«æ˜Ÿæ®–æ°‘åœ°çš„æ—¥å¸¸ç”Ÿæ´»ï¼Œææ˜Ÿè¾°çš„å·¥ä½œä¸å‹åŠ›\n2. å‘ç°ï¼šææ˜Ÿè¾°åœ¨å®éªŒä¸­å¶ç„¶å‘ç°äº†å…³é”®æŠ€æœ¯çªç ´\n3. äº‰è®®ï¼šæŠ€æœ¯å…¬å¸ƒåå¼•å‘çš„ä¼¦ç†ä¸å®‰å…¨äº‰è®®\n4. æŠ‰æ‹©ï¼šææ˜Ÿè¾°é¢ä¸´æ¥è‡ªå„æ–¹çš„å‹åŠ›ï¼Œå¿…é¡»åšå‡ºæœ€ç»ˆå†³å®š\n5. é«˜æ½®ï¼šæŠ€æœ¯åº”ç”¨åçš„æ„å¤–åæœï¼Œææ˜Ÿè¾°å¿…é¡»é‡‡å–è¡ŒåŠ¨\n6. ç»“å±€ï¼šææ˜Ÿè¾°çš„é€‰æ‹©åŠå…¶å¯¹äººç±»æœªæ¥çš„å½±å“\n\nä½ è§‰å¾—è¿™ä¸ªå¤§çº²å¦‚ä½•ï¼Ÿæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–æˆ–è€…è°ƒæ•´ã€‚', timestamp: new Date(), model: 'creative' },
                        { id: 'm7', role: 'user', content: 'éå¸¸å¥½ï¼ç°åœ¨æˆ‘éœ€è¦ä¸ºæ¯ä¸ªç« èŠ‚ç¼–å†™è¯¦ç»†å†…å®¹ã€‚æˆ‘æƒ³ä»ç¬¬ä¸€ç« å¼€å§‹ï¼Œæè¿°ç«æ˜Ÿæ®–æ°‘åœ°çš„ç¯å¢ƒå’Œä¸»è§’çš„æ—¥å¸¸ç”Ÿæ´»ã€‚', timestamp: new Date() },
                        { id: 'm8', role: 'ai', content: 'å¥½çš„ï¼Œç¬¬ä¸€ç« æ˜¯å»ºç«‹æ•…äº‹ä¸–ç•Œå’Œä»‹ç»ä¸»è§’çš„å…³é”®ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯æ¥ä¸“é—¨ç¼–å†™ç¬¬ä¸€ç« çš„å†…å®¹ï¼Œè¿™æ ·å¯ä»¥ä¿æŒä¸»çº¿å¤§çº²çš„æ¸…æ™°ï¼ŒåŒæ—¶åˆèƒ½æ·±å…¥å‘å±•å„ä¸ªç« èŠ‚çš„ç»†èŠ‚ã€‚', timestamp: new Date(), model: 'creative' }
                    ],
                    parent: null,
                    children: ['chapter1', 'chapter2', 'chapter3']
                },
                'chapter1': {
                    id: 'chapter1',
                    name: 'ç¬¬1ç« ï¼šçº¢è‰²æ˜Ÿçƒçš„é»æ˜',
                    messages: [
                        { id: 'c1m1', role: 'user', content: 'æˆ‘éœ€è¦è¯¦ç»†æå†™ç«æ˜Ÿæ®–æ°‘åœ°çš„ç¯å¢ƒï¼ŒåŒ…æ‹¬ç©¹é¡¶åŸå¸‚çš„ç»“æ„ã€ç«æ˜Ÿè¡¨é¢çš„æ™¯è§‚ï¼Œä»¥åŠä¸»è§’ææ˜Ÿè¾°çš„æ—¥å¸¸ç”Ÿæ´»ã€‚', timestamp: new Date() },
                        { id: 'c1m2', role: 'ai', content: 'æ²¡é—®é¢˜ï¼è®©æˆ‘ä»¬å¼€å§‹æ„å»ºç¬¬ä¸€ç« çš„å†…å®¹ã€‚\n\n**ç¬¬1ç« ï¼šçº¢è‰²æ˜Ÿçƒçš„é»æ˜**\n\næ™¨å…‰é€è¿‡ç©¹é¡¶çš„ç‰¹ç§ç»ç’ƒï¼Œåœ¨ç«æ˜Ÿæ®–æ°‘åœ°çš„é‡‘å±åœ°æ¿ä¸ŠæŠ•ä¸‹æ·¡çº¢è‰²çš„å…‰æ–‘ã€‚ææ˜Ÿè¾°ç«™åœ¨å®éªŒå®¤çš„çª—è¾¹ï¼Œæœ›ç€å¤–é¢è´«ç˜ çš„çº¢è‰²è’åŸã€‚è¿œå¤„ï¼Œå·¨å¤§çš„å¤ªé˜³èƒ½æ¿åœ¨é˜³å…‰ä¸‹é—ªé—ªå‘å…‰ï¼Œåƒä¸€ç‰‡é‡‘å±çš„æµ·æ´‹ã€‚\n\n"æ˜Ÿå“¥ï¼Œåˆåœ¨çœ‹åœ°çƒäº†ï¼Ÿ"åŠ©æ‰‹å°é™ˆçš„å£°éŸ³ä»èº«åä¼ æ¥ã€‚\n\nææ˜Ÿè¾°è½¬èº«ï¼Œéœ²å‡ºä¸€ä¸ªç–²æƒ«çš„å¾®ç¬‘ã€‚"æ˜¯å•Šï¼Œæœ‰ç‚¹æƒ³å®¶äº†ã€‚"ä»–èµ°åˆ°å®éªŒå°å‰ï¼Œçœ‹ç€åŸ¹å…»çš¿ä¸­æ­£åœ¨ç”Ÿé•¿çš„æ–°å‹ä½œç‰©ã€‚è¿™äº›ç»è¿‡åŸºå› æ”¹è‰¯çš„æ¤ç‰©ï¼Œæ˜¯è§£å†³æ®–æ°‘åœ°ç²®é£Ÿé—®é¢˜çš„å…³é”®ã€‚\n\n"ä»Šå¤©çš„å®éªŒæ•°æ®æ€ä¹ˆæ ·ï¼Ÿ"ææ˜Ÿè¾°é—®é“ï¼Œæˆ´ä¸Šæ‰‹å¥—å¼€å§‹æ£€æŸ¥æ ·æœ¬ã€‚\n\n"æƒ…å†µä¸å¤ªä¹è§‚ï¼Œ"å°é™ˆçš±ç€çœ‰å¤´è¯´ï¼Œ"ç¬¬ä¸‰ç»„æ ·æœ¬çš„ç”Ÿé•¿é€Ÿåº¦æ¯”é¢„æœŸæ…¢äº†30%ã€‚"\n\nææ˜Ÿè¾°çš„æ‰‹æŒ‡å¾®å¾®ä¸€é¡¿ã€‚è¿™å·²ç»æ˜¯è¿ç»­ç¬¬ä¸‰æ¬¡å‡ºç°è¿™æ ·çš„é—®é¢˜äº†ã€‚å¦‚æœä¸èƒ½è§£å†³è¿™ä¸ªéš¾é¢˜ï¼Œæ®–æ°‘åœ°çš„ç²®é£Ÿä¾›åº”å°†é¢ä¸´ä¸¥é‡å±æœº...\n\nè¿™ä¸ªå¼€å¤´æ€ä¹ˆæ ·ï¼Ÿæˆ‘ä»¬å¯ä»¥ç»§ç»­å®Œå–„å’Œæ‰©å±•ã€‚', timestamp: new Date(), model: 'creative' },
                        { id: 'c1m3', role: 'user', content: 'å¾ˆå¥½ï¼æˆ‘æƒ³å¢åŠ ä¸€äº›ä¸»è§’çš„å†…å¿ƒæå†™ï¼Œä»¥åŠä»–ä¸å‰å¥³å‹å¼ é›¨æ™´çš„å›å¿†ï¼Œä¸ºåç»­å‰§æƒ…åšé“ºå«ã€‚', timestamp: new Date() },
                        { id: 'c1m4', role: 'ai', content: 'å¥½ä¸»æ„ï¼åŠ å…¥è¿™äº›å…ƒç´ å¯ä»¥ä½¿äººç‰©å½¢è±¡æ›´åŠ ä¸°æ»¡ï¼Œä¹Ÿèƒ½ä¸ºåç»­çš„å†²çªåŸ‹ä¸‹ä¼ç¬”ã€‚\n\n**ç¬¬1ç« ï¼šçº¢è‰²æ˜Ÿçƒçš„é»æ˜ï¼ˆç»­ï¼‰**\n\nææ˜Ÿè¾°çš„ç›®å…‰è½åœ¨å®éªŒå°è§’è½çš„ä¸€å¼ ç…§ç‰‡ä¸Šã€‚ç…§ç‰‡é‡Œï¼Œä»–å’Œå¼ é›¨æ™´ç«™åœ¨åœ°çƒçš„æµ·æ»©ä¸Šï¼Œé˜³å…‰æ´’åœ¨ä»–ä»¬çš„ç¬‘è„¸ä¸Šã€‚é‚£æ˜¯ä¸‰å¹´å‰ï¼Œåœ¨ä»–å†³å®šå‰å¾€ç«æ˜Ÿä¹‹å‰æ‹æ‘„çš„ã€‚\n\n"é›¨æ™´ï¼Œä½ è¯´å¾—å¯¹ï¼Œ"ä»–è½»å£°è‡ªè¯­ï¼Œ"äººç±»ç¡®å®åº”è¯¥æ›´åŠ å°Šé‡è‡ªç„¶è§„å¾‹ã€‚ä½†ç°åœ¨..."ä»–æœ›ç€åŸ¹å…»çš¿ä¸­çš„ä½œç‰©ï¼Œ"æˆ‘ä»¬æ²¡æœ‰æ—¶é—´äº†ã€‚"\n\nä¸‰å¹´å‰çš„äº‰åµä»¿ä½›è¿˜åœ¨è€³è¾¹ã€‚"æ˜Ÿè¾°ï¼Œä½ æ€»æ˜¯è¿™ä¹ˆæ€¥åŠŸè¿‘åˆ©ï¼"å¼ é›¨æ™´çš„å£°éŸ³å¸¦ç€å“­è…”ï¼Œ"åŸºå› æŠ€æœ¯ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä½ éš¾é“ä¸æ‹…å¿ƒä¼šæœ‰ä»€ä¹ˆå¯æ€•çš„åæœå—ï¼Ÿ"\n\n"ä½†å¦‚æœæˆ‘ä»¬ä¸å†’é™©ï¼Œäººç±»å°±æ²¡æœ‰æœªæ¥ï¼"ææ˜Ÿè¾°å½“æ—¶çš„å›ç­”æ–©é’‰æˆªé“ã€‚\n\nç°åœ¨å›æƒ³èµ·æ¥ï¼Œä»–æœ‰äº›åæ‚”å½“æ—¶çš„æ€åº¦ã€‚ä½†æœ¨å·²æˆèˆŸï¼Œä»–å·²ç»æ¥åˆ°äº†ç«æ˜Ÿï¼Œè‚©è´Ÿç€æ•°ç™¾äººç”Ÿå‘½çš„é‡æ‹…...\n\nä½ è§‰å¾—è¿™æ ·ä¿®æ”¹å¦‚ä½•ï¼Ÿæˆ‘ä»¬å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šç»†èŠ‚ã€‚', timestamp: new Date(), model: 'creative' }
                    ],
                    parent: {
                        branch: 'main',
                        messageIds: ['m7', 'm8']
                    },
                    children: []
                },
                'chapter2': {
                    id: 'chapter2',
                    name: 'ç¬¬2ç« ï¼šæ„å¤–çš„å‘ç°',
                    messages: [
                        { id: 'c2m1', role: 'user', content: 'åœ¨ç¬¬äºŒç« ä¸­ï¼Œæˆ‘å¸Œæœ›ä¸»è§’ææ˜Ÿè¾°åœ¨å®éªŒä¸­å¶ç„¶å‘ç°å…³é”®çš„æŠ€æœ¯çªç ´ã€‚è¿™ä¸ªå‘ç°åº”è¯¥æ—¢ä»¤äººå…´å¥‹ï¼Œåˆå……æ»¡æ½œåœ¨çš„é£é™©ã€‚', timestamp: new Date() },
                        { id: 'c2m2', role: 'ai', content: 'æ˜ç™½ï¼è®©æˆ‘ä»¬æ¥è®¾è®¡è¿™ä¸ªå…³é”®çš„å‘ç°åœºæ™¯ã€‚\n\n**ç¬¬2ç« ï¼šæ„å¤–çš„å‘ç°**\n\næ·±å¤œï¼Œå®éªŒå®¤çš„ç¯å…‰ä¾ç„¶äº®ç€ã€‚ææ˜Ÿè¾°æ‰äº†æ‰ç–²æƒ«çš„çœ¼ç›ï¼Œç›¯ç€æ˜¾å¾®é•œä¸‹çš„ç»†èƒæ ·æœ¬ã€‚å·²ç»è¿ç»­å·¥ä½œäº†16ä¸ªå°æ—¶ï¼Œä»–çš„è„‘æµ·é‡Œå…¨æ˜¯å„ç§æ•°æ®å’Œå…¬å¼ã€‚\n\nçªç„¶ï¼Œä»–çš„çœ¼ç›ä¸€äº®ã€‚æ˜¾å¾®é•œä¸‹çš„ç»†èƒç»“æ„æœ‰äº›ä¸åŒå¯»å¸¸â€”â€”ç»†èƒæ ¸å‘¨å›´ç¯ç»•ç€ä¸€åœˆå¾®å¼±çš„å…‰æ™•ã€‚è¿™æ˜¯ä¹‹å‰ä»æœªè§‚å¯Ÿåˆ°çš„ç°è±¡ã€‚\n\n"å°é™ˆï¼å¿«è¿‡æ¥ï¼"ææ˜Ÿè¾°çš„å£°éŸ³æœ‰äº›é¢¤æŠ–ã€‚\n\nå°é™ˆæ‰ç€çœ¼ç›èµ°è¿›å®éªŒå®¤ï¼š"æ˜Ÿå“¥ï¼Œè¿™ä¹ˆæ™šäº†è¿˜æ²¡ä¼‘æ¯ï¼Ÿ"\n\n"ä½ çœ‹è¿™ä¸ªï¼"ææ˜Ÿè¾°è®©å¼€ä½ç½®ï¼Œ"è¿™ä¸ªæ ·æœ¬çš„åŸºå› è¡¨è¾¾æ¨¡å¼å®Œå…¨ä¸åŒï¼"\n\nå°é™ˆå‡‘è¿‘æ˜¾å¾®é•œï¼Œçœ¼ç›ä¹Ÿç«‹åˆ»äº®äº†èµ·æ¥ï¼š"è¿™...è¿™ä¸å¯èƒ½ï¼æˆ‘ä»¬çš„æ”¹è‰¯æ–¹æ¡ˆä¸åº”è¯¥æœ‰è¿™ç§æ•ˆæœï¼"\n\nææ˜Ÿè¾°è¿…é€Ÿè½¬èº«ï¼Œå¼€å§‹åœ¨ç”µè„‘ä¸Šè¾“å…¥æŒ‡ä»¤ï¼š"é©¬ä¸Šå‡†å¤‡æµ‹åºï¼æˆ‘è¦çŸ¥é“è¿™ä¸ªæ ·æœ¬çš„å…¨éƒ¨åŸºå› åºåˆ—ï¼"\n\nä¸‰ä¸ªå°æ—¶åï¼Œæµ‹åºç»“æœå‡ºæ¥äº†ã€‚ææ˜Ÿè¾°ç›¯ç€ç”µè„‘å±å¹•ä¸Šçš„æ•°æ®ï¼ŒåŒæ‰‹å¾®å¾®é¢¤æŠ–ã€‚è¿™ä¸ªæ„å¤–çš„çªå˜ï¼Œç«Ÿç„¶è®©ä½œç‰©çš„ç”Ÿé•¿é€Ÿåº¦æé«˜äº†äº”å€ï¼ŒåŒæ—¶å¯¹ç«æ˜Ÿçš„æ¶åŠ£ç¯å¢ƒæœ‰äº†æ›´å¼ºçš„é€‚åº”æ€§ã€‚\n\nä½†åœ¨å…´å¥‹ä¹‹ä½™ï¼Œä»–çš„å¿ƒé‡Œä¹Ÿå‡èµ·äº†ä¸€ä¸æ‹…å¿§ã€‚è¿™ä¸ªçªå˜æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿå®ƒçœŸçš„å®‰å…¨å—ï¼Ÿ\n\n"ä¹Ÿè®¸ï¼Œ"ä»–æœ›ç€çª—å¤–çš„çº¢è‰²è’åŸï¼Œ"è¿™å°±æ˜¯äººç±»çš„è½¬æœºã€‚"\n\nä½ è§‰å¾—è¿™ä¸ªå‘ç°åœºæ™¯å¦‚ä½•ï¼Ÿæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ç»†èŠ‚ã€‚', timestamp: new Date(), model: 'creative' }
                    ],
                    parent: {
                        branch: 'main',
                        messageIds: ['m7', 'm8']
                    },
                    children: []
                },
                'chapter3': {
                    id: 'chapter3',
                    name: 'ç¬¬3ç« ï¼šä¼¦ç†çš„äº‰è®®',
                    messages: [
                        { id: 'c3m1', role: 'user', content: 'åœ¨ç¬¬ä¸‰ç« ä¸­ï¼Œæˆ‘å¸Œæœ›æè¿°æŠ€æœ¯å…¬å¸ƒåå¼•å‘çš„ä¼¦ç†å’Œå®‰å…¨äº‰è®®ã€‚ç‰¹åˆ«æ˜¯ä¸»è§’çš„å‰å¥³å‹å¼ é›¨æ™´ä½œä¸ºåœ°çƒç¯å¢ƒç§‘å­¦å®¶ï¼Œå¯èƒ½ä¼šå¼ºçƒˆåå¯¹è¿™é¡¹æŠ€æœ¯ã€‚', timestamp: new Date() },
                        { id: 'c3m2', role: 'ai', content: 'è¿™ä¸ªå†²çªè®¾è®¡éå¸¸ç²¾å½©ï¼ä¼¦ç†äº‰è®®æ˜¯ç§‘å¹»å°è¯´ä¸­å¸¸è§ä½†æ·±åˆ»çš„ä¸»é¢˜ã€‚\n\n**ç¬¬3ç« ï¼šä¼¦ç†çš„äº‰è®®**\n\næ–°é—»å‘å¸ƒä¼šçš„ç°åœºä¸€ç‰‡å“—ç„¶ã€‚å½“ææ˜Ÿè¾°å±•ç¤ºæœ€æ–°çš„å®éªŒæ•°æ®æ—¶ï¼Œå°ä¸‹çš„è®°è€…ä»¬çº·çº·ä¸¾èµ·äº†æ‰‹ï¼Œé—®é¢˜ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æŠ›è¿‡æ¥ã€‚\n\n"æåšå£«ï¼Œè¿™é¡¹æŠ€æœ¯çš„å®‰å…¨æ€§å¦‚ä½•ï¼Ÿä½ ä»¬åšè¿‡é•¿æœŸçš„ç¯å¢ƒå½±å“è¯„ä¼°å—ï¼Ÿ"\n\n"è¿™é¡¹æŠ€æœ¯æ˜¯å¦å¯èƒ½å¯¼è‡´ä¸å¯æ§çš„åŸºå› æ‰©æ•£ï¼Ÿ"\n\n"æœ‰äººæ‹…å¿ƒè¿™ä¼šå¼€å¯åŸºå› ç¼–è¾‘çš„æ½˜å¤šæ‹‰é­”ç›’ï¼Œæ‚¨å¯¹æ­¤æœ‰ä½•å›åº”ï¼Ÿ"\n\nææ˜Ÿè¾°ä¿æŒç€å†·é™ï¼š"æˆ‘ä»¬çš„å®éªŒæ•°æ®è¡¨æ˜ï¼Œè¿™é¡¹æŠ€æœ¯æ˜¯å®‰å…¨å¯æ§çš„ã€‚å®ƒå°†å¸®åŠ©äººç±»è§£å†³ç²®é£Ÿå±æœºï¼Œç‰¹åˆ«æ˜¯åœ¨ç«æ˜Ÿè¿™æ ·çš„æç«¯ç¯å¢ƒä¸­ã€‚"\n\nä½†äº‰è®®å¹¶æ²¡æœ‰å°±æ­¤å¹³æ¯ã€‚å½“å¤©æ™šä¸Šï¼Œææ˜Ÿè¾°æ”¶åˆ°äº†ä¸€å°æ¥è‡ªåœ°çƒçš„åŠ å¯†é‚®ä»¶ã€‚å‘ä»¶äººæ˜¯å¼ é›¨æ™´ã€‚\n\n"æ˜Ÿè¾°ï¼Œä½ ç–¯äº†å—ï¼Ÿ"é‚®ä»¶çš„å¼€å¤´å……æ»¡äº†æŒ‡è´£ï¼Œ"è¿™é¡¹æŠ€æœ¯çš„é£é™©æ˜¯ä¸å¯é¢„æµ‹çš„ï¼ä½ è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰çš„äº‰è®ºå—ï¼Ÿä½ å½“æ—¶è¯´è¦è°¨æ…ï¼Œä½†ç°åœ¨ä½ å´åœ¨æ‹¿å…¨äººç±»çš„æœªæ¥å†’é™©ï¼"\n\nææ˜Ÿè¾°çš„æ‰‹æŒ‡åœåœ¨é”®ç›˜ä¸Šã€‚ä»–çŸ¥é“å¼ é›¨æ™´æ˜¯å¯¹çš„ï¼Œè¿™é¡¹æŠ€æœ¯ç¡®å®å­˜åœ¨æœªçŸ¥çš„é£é™©ã€‚ä½†ç«æ˜Ÿæ®–æ°‘åœ°çš„ç²®é£Ÿå‚¨å¤‡åªèƒ½ç»´æŒä¸‰ä¸ªæœˆäº†ï¼Œä»–æ²¡æœ‰æ—¶é—´ç­‰å¾…æ›´å¤šçš„å®‰å…¨è¯„ä¼°ã€‚\n\n"æˆ‘å¿…é¡»è¿™ä¹ˆåšï¼Œ"ä»–åœ¨å¿ƒé‡Œé»˜é»˜åœ°è¯´ï¼Œ"ä¸ºäº†è¿™é‡Œçš„æ¯ä¸€ä¸ªäººã€‚"\n\nä½ è§‰å¾—è¿™ä¸ªå†²çªåœºæ™¯å¦‚ä½•ï¼Ÿæˆ‘ä»¬å¯ä»¥ç»§ç»­æ·±å…¥æ¢è®¨ä¸åŒè§’è‰²çš„ç«‹åœºå’ŒåŠ¨æœºã€‚', timestamp: new Date(), model: 'creative' }
                    ],
                    parent: {
                        branch: 'main',
                        messageIds: ['m7', 'm8']
                    },
                    children: []
                }
            },
            currentBranch: 'main',
            currentModel: 'creative'
        };
        
        // å®šä¹‰å¯ç”¨çš„AIæ¨¡å‹
        const availableModels = [
            { id: 'default', name: 'é€šç”¨åŠ©æ‰‹', description: 'å¹³è¡¡çš„é€šç”¨å¯¹è¯æ¨¡å‹' },
            { id: 'technical', name: 'æŠ€æœ¯ä¸“å®¶', description: 'ä¸“æ³¨äºæŠ€æœ¯é—®é¢˜çš„æ¨¡å‹' },
            { id: 'creative', name: 'åˆ›æ„ç”Ÿæˆå™¨', description: 'æ“…é•¿åˆ›æ„å†…å®¹ç”Ÿæˆçš„æ¨¡å‹' },
            { id: 'simplifier', name: 'ç®€åŒ–è§£é‡Šå¸ˆ', description: 'æ“…é•¿ç”¨ç®€å•è¯­è¨€è§£é‡Šå¤æ‚æ¦‚å¿µçš„æ¨¡å‹' }
        ];
        
        // å­˜å‚¨å½“å‰é€‰ä¸­çš„æ¶ˆæ¯ID
        let selectedMessages = [];
        // å­˜å‚¨å·²æ ‡è®°çš„æ¶ˆæ¯å†…å®¹
        let markedContents = [];

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            renderBranchTree();
            renderCurrentBranch();
            
            // å‘é€æ¶ˆæ¯äº‹ä»¶
            document.getElementById('sendMessage').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // åˆ†æ”¯åˆ›å»ºäº‹ä»¶
            document.getElementById('newMainBranch').addEventListener('click', showBranchCreatePanel);
            document.getElementById('cancelBranch').addEventListener('click', hideBranchCreatePanel);
            document.getElementById('createBranch').addEventListener('click', createNewBranch);
            
            // åˆå¹¶åˆ†æ”¯äº‹ä»¶
            document.getElementById('mergeBranches').addEventListener('click', showMergePanel);
            document.getElementById('cancelMerge').addEventListener('click', hideMergePanel);
            document.getElementById('confirmMerge').addEventListener('click', mergeBranches);
            
            // åŸºäºé€‰ä¸­å†…å®¹åˆ›å»ºåˆ†æ”¯äº‹ä»¶
            document.getElementById('createFromSelection').addEventListener('click', createBranchFromSelection);
            document.getElementById('clearSelection').addEventListener('click', clearMessageSelection);
            document.getElementById('generateSummary').addEventListener('click', generateSummary);
            
            // æµç¨‹å›¾ç›¸å…³äº‹ä»¶
            document.getElementById('viewFlowGraph').addEventListener('click', showFlowGraph);
            document.getElementById('closeFlowGraph').addEventListener('click', hideFlowGraph);
            
            // æ‘˜è¦ç›¸å…³äº‹ä»¶
            document.getElementById('cancelSummary').addEventListener('click', hideSummary);
            document.getElementById('createBranchFromSummary').addEventListener('click', createBranchFromSummary);
            
            // å·²æ ‡è®°å†…å®¹ç›¸å…³äº‹ä»¶
            document.getElementById('showMarkedContents').addEventListener('click', showMarkedContents);
            document.getElementById('closeMarkedContents').addEventListener('click', hideMarkedContents);
        });

        // æ¸²æŸ“åˆ†æ”¯æ ‘
        function renderBranchTree() {
            const branchTree = document.getElementById('branchTree');
            branchTree.innerHTML = '';
            
            // é€’å½’æ¸²æŸ“åˆ†æ”¯
            function renderBranch(branchId, level = 0) {
                const branch = conversationData.branches[branchId];
                const branchNode = document.createElement('div');
                branchNode.className = `branch-node ${conversationData.currentBranch === branchId ? 'active' : ''}`;
                branchNode.style.paddingLeft = `${10 + level * 20}px`;
                branchNode.dataset.branchId = branchId;
                
                branchNode.innerHTML = `
                    <div class="branch-name">${branch.name}</div>
                    <div class="branch-content">${branch.messages[branch.messages.length - 1]?.content.substring(0, 30) || 'ç©ºåˆ†æ”¯'}...</div>
                `;
                
                branchNode.addEventListener('click', () => switchBranch(branchId));
                branchTree.appendChild(branchNode);
                
                // æ¸²æŸ“å­åˆ†æ”¯
                branch.children.forEach(childId => {
                    renderBranch(childId, level + 1);
                });
            }
            
            // ä»æ ¹åˆ†æ”¯å¼€å§‹æ¸²æŸ“
            Object.keys(conversationData.branches).forEach(branchId => {
                if (!conversationData.branches[branchId].parent) {
                    renderBranch(branchId);
                }
            });
        }

        // æ¸²æŸ“å½“å‰åˆ†æ”¯çš„å¯¹è¯
        function renderCurrentBranch() {
            const chatMessages = document.getElementById('chatMessages');
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            chatMessages.innerHTML = '';
            currentBranch.messages.forEach((message, index) => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.role === 'user' ? 'user-message' : message.role === 'ai' ? 'ai-message' : 'system'}`;
                messageElement.dataset.messageId = message.id;
                
                // æ ‡è®°åˆ†æ”¯èµ·å§‹ç‚¹
                if (currentBranch.parent && index === 0) {
                    messageElement.classList.add('branch-start-point');
                }
                
                messageElement.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-actions">
                        <button class="action-btn select-message" title="é€‰æ‹©/å–æ¶ˆé€‰æ‹©æ­¤æ¶ˆæ¯">âœ…</button>
                        <button class="action-btn branch-from-here" title="ä»æ­¤å¤„åˆ›å»ºåˆ†æ”¯(åŒ…å«æ‰€æœ‰å†å²)">ğŸŒ¿</button>
                        <button class="action-btn branch-only-this" title="ä»…ä»¥æ­¤å†…å®¹ä¸ºåŸºç¡€åˆ›å»ºåˆ†æ”¯">âœ‚ï¸</button>
                        <button class="action-btn highlight-keywords" title="æ ‡è®°å…³é”®è¯">ğŸ”–</button>
                        <button class="action-btn mark-content" title="æ ‡è®°å†…å®¹">â­</button>
                        <button class="action-btn switch-model" title="åˆ‡æ¢AIæ¨¡å‹" ${message.role !== 'ai' ? 'style="display:none"' : ''}>ğŸ”„</button>
                    </div>
                `;
                
                // é‡æ–°è®¾ç½®data-message-idå±æ€§ï¼Œç¡®ä¿toggleMessageSelectionèƒ½æ‰¾åˆ°å…ƒç´ 
                messageElement.dataset.messageId = message.id;
                
                chatMessages.appendChild(messageElement);
                
                // æ·»åŠ æ¶ˆæ¯é€‰æ‹©äº‹ä»¶
                messageElement.addEventListener('click', (e) => {
                    // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯æ¶ˆæ¯å†…å®¹åŒºåŸŸæ—¶æ‰è§¦å‘é€‰æ‹©
                    const contentElement = messageElement.querySelector('.message-content');
                    if (e.target === contentElement || contentElement.contains(e.target)) {
                        toggleMessageSelection(message.id);
                    }
                });
                
                // æ·»åŠ å¤šé€‰æŒ‰é’®äº‹ä»¶
                messageElement.querySelector('.select-message').addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMessageSelection(message.id);
                });
                
                // æ·»åŠ åˆ†æ”¯åˆ›å»ºäº‹ä»¶ - ç›´æ¥åˆ›å»ºåˆ†æ”¯è€Œä¸æ˜¾ç¤ºé¢æ¿
                messageElement.querySelector('.branch-from-here').addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // ç›´æ¥åˆ›å»ºåˆ†æ”¯ - åŒ…å«æ‰€æœ‰å†å²æ¶ˆæ¯
                    const newBranchId = 'branch_' + Date.now();
                    const currentBranch = conversationData.branches[conversationData.currentBranch];
                    
                    // ç¡®å®šæ–°åˆ†æ”¯çš„èµ·å§‹æ¶ˆæ¯ç´¢å¼•
                    let startingPoint = 0;
                    if (message.id) {
                        startingPoint = currentBranch.messages.findIndex(m => m.id === message.id);
                    }
                    
                    // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«èµ·å§‹ç‚¹åŠä¹‹å‰çš„æ¶ˆæ¯
                    conversationData.branches[newBranchId] = {
                        id: newBranchId,
                        name: `åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                        messages: [
                            // åªåŒ…å«èµ·å§‹ç‚¹åŠä¹‹å‰çš„æ¶ˆæ¯
                            ...currentBranch.messages.slice(0, startingPoint + 1)
                        ],
                        parent: {
                            branch: conversationData.currentBranch,
                            messageId: message.id
                        },
                        children: []
                    };
                    
                    // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
                    currentBranch.children.push(newBranchId);
                    
                    // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
                    switchBranch(newBranchId);
                });
                
                // æ·»åŠ æ ‡è®°å†…å®¹äº‹ä»¶
                    messageElement.querySelector('.mark-content').addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleContentMark(message.id, message.content, message.role);
                    });
                    
                    // æ·»åŠ åˆ‡æ¢æ¨¡å‹äº‹ä»¶
                    if (message.role === 'ai') {
                        messageElement.querySelector('.switch-model').addEventListener('click', (e) => {
                            e.stopPropagation();
                            showModelSwitchPanel(message.id);
                        });
                    }
                    
                    // æ·»åŠ ä»…ä»¥æ­¤å†…å®¹ä¸ºåŸºç¡€åˆ›å»ºåˆ†æ”¯çš„äº‹ä»¶
                    messageElement.querySelector('.branch-only-this').addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // ç›´æ¥åˆ›å»ºåˆ†æ”¯ - ä»…åŒ…å«é€‰ä¸­çš„æ¶ˆæ¯å†…å®¹
                    const newBranchId = 'branch_' + Date.now();
                    const currentBranch = conversationData.branches[conversationData.currentBranch];
                    
                    // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«é€‰ä¸­çš„æ¶ˆæ¯
                    conversationData.branches[newBranchId] = {
                        id: newBranchId,
                        name: `ä»…é€‰åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                        messages: [
                            // ä»…åŒ…å«é€‰ä¸­çš„æ¶ˆæ¯
                            {
                                ...message, // å¤åˆ¶é€‰ä¸­çš„æ¶ˆæ¯å†…å®¹
                                id: 'm' + Date.now() // ç”Ÿæˆæ–°çš„IDä»¥é¿å…å†²çª
                            }
                        ],
                        parent: {
                            branch: conversationData.currentBranch,
                            messageId: message.id
                        },
                        children: []
                    };
                    
                    // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
                    currentBranch.children.push(newBranchId);
                    
                    // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
                    switchBranch(newBranchId);
                });
            });
            
            // æ›´æ–°åˆ†æ”¯ä¿¡æ¯
            document.getElementById('currentBranchName').textContent = currentBranch.name;
            document.getElementById('branchPath').textContent = `è·¯å¾„: ${getBranchPath(currentBranch.id)}`;
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // è·å–åˆ†æ”¯è·¯å¾„
        function getBranchPath(branchId) {
            let path = [];
            let currentBranch = conversationData.branches[branchId];
            
            while (currentBranch) {
                path.unshift(currentBranch.name);
                if (currentBranch.parent) {
                    currentBranch = conversationData.branches[currentBranch.parent.branch];
                } else {
                    currentBranch = null;
                }
            }
            
            return path.join(' â†’ ');
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                const currentBranch = conversationData.branches[conversationData.currentBranch];
                const messageId = 'm' + Date.now();
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                currentBranch.messages.push({
                    id: messageId,
                    role: 'user',
                    content: message,
                    timestamp: new Date()
                });
                
                // æ¨¡æ‹ŸAIå›å¤
                setTimeout(() => {
                    const aiMessageId = 'm' + Date.now();
                    currentBranch.messages.push({
                        id: aiMessageId,
                        role: 'ai',
                        content: generateAIResponse(message, currentBranch.messages),
                        timestamp: new Date()
                    });
                    
                    renderCurrentBranch();
                    renderBranchTree();
                }, 1000);
                
                renderCurrentBranch();
                input.value = '';
            }
        }

        // ç”ŸæˆAIå›å¤ï¼ˆæ¨¡æ‹Ÿï¼‰
        function generateAIResponse(userMessage, messageHistory, modelId = 'default') {
            // ä¸åŒæ¨¡å‹çš„å“åº”æ¨¡å¼
            const modelResponses = {
                default: [
                    "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚",
                    "åŸºäºæˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œæˆ‘è®¤ä¸º...",
                    "æ‚¨æåˆ°äº†ä¸€ä¸ªå…³é”®ç‚¹ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘æƒ³è¡¥å……...",
                    "æˆ‘ç†è§£æ‚¨çš„ç–‘é—®ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥ä»å¤šä¸ªè§’åº¦æ¥ç†è§£...",
                    "æ„Ÿè°¢æ‚¨çš„æé—®ï¼è¿™è®©æˆ‘æƒ³åˆ°äº†ç›¸å…³çš„æ¦‚å¿µ..."
                ],
                technical: [
                    "ä»æŠ€æœ¯è§’åº¦åˆ†æï¼Œè¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š",
                    "æ ¹æ®æˆ‘çš„æŠ€æœ¯ç†è§£ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•è§£å†³ï¼š",
                    "è¿™ä¸ªæŠ€æœ¯é—®é¢˜çš„å…³é”®ç‚¹åœ¨äº...",
                    "ä»å®ç°ç»†èŠ‚æ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘...",
                    "åœ¨æŠ€æœ¯é€‰å‹ä¸Šï¼Œæˆ‘å»ºè®®..."
                ],
                creative: [
                    "è®©æˆ‘ä»åˆ›æ„çš„è§’åº¦æ¥æ€è€ƒè¿™ä¸ªé—®é¢˜...",
                    "è¿™é‡Œæœ‰ä¸€äº›åˆ›é€ æ€§çš„è§£å†³æ–¹æ¡ˆ...",
                    "æ¢ä¸ªè§’åº¦çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å°è¯•...",
                    "åˆ›æ„å±‚é¢ä¸Šï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥æœ‰å¤šç§æœ‰è¶£çš„è§£å†³æ–¹å¼...",
                    "ä»åˆ›æ–°è§†è§’å‡ºå‘ï¼Œæˆ‘æƒ³åˆ°äº†ä»¥ä¸‹å¯èƒ½æ€§..."
                ],
                simplifier: [
                    "ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥è¿™æ ·ç†è§£...",
                    "è®©æˆ‘ç”¨æ›´ç®€å•çš„è¯­è¨€è§£é‡Šä¸€ä¸‹...",
                    "å…¶å®è¿™ä¸ªæ¦‚å¿µå¹¶ä¸å¤æ‚ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯...",
                    "ä¸ºäº†æ›´å®¹æ˜“ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ¯”å–»...",
                    "ç®€åŒ–ä¸€ä¸‹ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯..."
                ]
            };
            
            const responses = modelResponses[modelId] || modelResponses.default;
            
            // ç®€å•æ¨¡æ‹Ÿæ ¹æ®æ¶ˆæ¯å†å²ç”Ÿæˆå›å¤
            if (userMessage.includes('?')) {
                const modelPrefixes = {
                    default: "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ·±åº¦ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘è®¤ä¸º...",
                    technical: "æ ¹æ®æŠ€æœ¯åŸç†ï¼Œè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯...",
                    creative: "ä»åˆ›æ„è§’åº¦å‡ºå‘ï¼Œæˆ‘çš„çœ‹æ³•æ˜¯...",
                    simplifier: "ç®€å•æ¥è¯´ï¼Œç­”æ¡ˆå¯ä»¥è¿™æ ·ç†è§£..."
                };
                const prefix = modelPrefixes[modelId] || modelPrefixes.default;
                return prefix + responses[Math.floor(Math.random() * responses.length)];
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // æ˜¾ç¤ºæ¨¡å‹åˆ‡æ¢é¢æ¿
        function showModelSwitchPanel(messageId) {
            const panel = document.getElementById('modelSwitchPanel');
            const overlay = document.getElementById('modalOverlay');
            
            // ä¿å­˜å½“å‰è¦åˆ‡æ¢çš„æ¶ˆæ¯ID
            panel.dataset.messageId = messageId;
            
            // æ˜¾ç¤ºé¢æ¿å’Œé®ç½©
            panel.style.display = 'block';
            overlay.style.display = 'block';
            
            // é¢„é€‰ä¸­å½“å‰æ¨¡å‹
            const currentMessage = getMessageById(messageId);
            if (currentMessage && currentMessage.model) {
                const modelRadio = document.querySelector(`input[name="modelType"][value="${currentMessage.model}"]`);
                if (modelRadio) {
                    modelRadio.checked = true;
                }
            }
        }
        
        // éšè—æ¨¡å‹åˆ‡æ¢é¢æ¿
        function hideModelSwitchPanel() {
            document.getElementById('modelSwitchPanel').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }
        
        // æ ¹æ®æ¶ˆæ¯IDè·å–æ¶ˆæ¯å¯¹è±¡
        function getMessageById(messageId) {
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            return currentBranch.messages.find(msg => msg.id === messageId);
        }
        
        // åˆ‡æ¢AIæ¨¡å‹
        function switchAIModel() {
            const panel = document.getElementById('modelSwitchPanel');
            const messageId = panel.dataset.messageId;
            const selectedModel = document.querySelector('input[name="modelType"]:checked').value;
            
            // è·å–å½“å‰æ¶ˆæ¯å’Œåˆ†æ”¯
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            const messageIndex = currentBranch.messages.findIndex(msg => msg.id === messageId);
            const message = currentBranch.messages[messageIndex];
            
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å­˜åœ¨ä¸”ä¸ºAIå›å¤
            if (messageIndex === -1 || message.role !== 'ai') {
                hideModelSwitchPanel();
                return;
            }
            
            // æ›´æ–°å½“å‰æ¨¡å‹è®¾ç½®
            conversationData.currentModel = selectedModel;
            
            // ç”Ÿæˆæ¶ˆæ¯æ‘˜è¦
            const summary = generateMessageSummary(message.content);
            
            // åˆ›å»ºæ–°åˆ†æ”¯ï¼Œä½¿ç”¨æ–°æ¨¡å‹é‡æ–°ç”Ÿæˆå›å¤
            const newBranchId = 'branch_' + Date.now();
            
            // å¤åˆ¶å½“å‰åˆ†æ”¯çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œç›´åˆ°è¦åˆ‡æ¢çš„æ¶ˆæ¯ä¹‹å‰
            const newMessages = [...currentBranch.messages.slice(0, messageIndex)];
            
            // æ·»åŠ ç”¨æˆ·è¯·æ±‚åˆ‡æ¢æ¨¡å‹çš„ç³»ç»Ÿæ¶ˆæ¯
            newMessages.push({
                id: 'm' + Date.now(),
                role: 'system',
                content: `[åˆ‡æ¢åˆ°${availableModels.find(m => m.id === selectedModel).name}æ¨¡å‹ï¼ŒåŸºäºä»¥ä¸‹å†…å®¹è¿›è¡Œé‡æ–°å›å¤]\n\n${summary}`,
                timestamp: new Date()
            });
            
            // ç«‹å³æ˜¾ç¤ºæç¤ºï¼Œè¯´æ˜æ­£åœ¨ç”Ÿæˆæ–°å›å¤
            renderCurrentBranch();
            
            // æ¨¡æ‹Ÿæ–°æ¨¡å‹ç”Ÿæˆå›å¤ï¼ˆä½¿ç”¨setTimeoutæ¨¡æ‹Ÿå»¶è¿Ÿï¼‰
            setTimeout(() => {
                const newAIMessageId = 'm' + Date.now();
                const newAIMessage = {
                    id: newAIMessageId,
                    role: 'ai',
                    content: generateAIResponse(summary, newMessages, selectedModel),
                    timestamp: new Date(),
                    model: selectedModel
                };
                
                // æ›´æ–°æ–°åˆ†æ”¯æ¶ˆæ¯
                newMessages.push(newAIMessage);
                
                // åˆ›å»ºæ–°åˆ†æ”¯
                conversationData.branches[newBranchId] = {
                    id: newBranchId,
                    name: `[${availableModels.find(m => m.id === selectedModel).name}] ${currentBranch.name}`,
                    messages: newMessages,
                    parent: {
                        branch: conversationData.currentBranch,
                        messageId: messageId,
                        modelSwitch: true,
                        fromModel: message.model || 'default',
                        toModel: selectedModel
                    },
                    children: []
                };
                
                // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
                currentBranch.children.push(newBranchId);
                
                // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
                switchBranch(newBranchId);
                
                // éšè—é¢æ¿
                hideModelSwitchPanel();
            }, 1000);
        }
        
        // ç”Ÿæˆæ¶ˆæ¯æ‘˜è¦
        function generateMessageSummary(messageContent) {
            // ç®€å•çš„æ‘˜è¦ç”Ÿæˆé€»è¾‘
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„NLPç®—æ³•
            if (messageContent.length <= 100) {
                return messageContent; // å¦‚æœæ¶ˆæ¯æœ¬èº«å°±ä¸é•¿ï¼Œç›´æ¥è¿”å›
            }
            
            // ç®€å•æˆªå–å‰100ä¸ªå­—ç¬¦å¹¶æ·»åŠ çœç•¥å·
            return messageContent.substring(0, 100) + '...';
        }

        // æ˜¾ç¤ºåˆ†æ”¯åˆ›å»ºé¢æ¿
        function showBranchCreatePanel(fromMessageId = null) {
            const panel = document.getElementById('branchCreatePanel');
            panel.style.display = 'block';
            panel.dataset.fromMessageId = fromMessageId;
            
            // å®šä½é¢æ¿
            if (fromMessageId) {
                const messageElement = document.querySelector(`[data-message-id="${fromMessageId}"]`);
                const rect = messageElement.getBoundingClientRect();
                panel.style.top = `${rect.top}px`;
                panel.style.left = `${rect.right + 10}px`;
            } else {
                panel.style.top = '50%';
                panel.style.left = '50%';
                panel.style.transform = 'translate(-50%, -50%)';
            }
        }

        // éšè—åˆ†æ”¯åˆ›å»ºé¢æ¿
        function hideBranchCreatePanel() {
            document.getElementById('branchCreatePanel').style.display = 'none';
        }

        // åˆ›å»ºæ–°åˆ†æ”¯
        function createNewBranch() {
            const fromMessageId = document.getElementById('branchCreatePanel').dataset.fromMessageId;
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // ç¡®å®šæ–°åˆ†æ”¯çš„èµ·å§‹æ¶ˆæ¯ç´¢å¼•
            let startingPoint = 0;
            if (fromMessageId) {
                startingPoint = currentBranch.messages.findIndex(m => m.id === fromMessageId);
            }
            
            // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«èµ·å§‹ç‚¹åŠä¹‹å‰çš„æ¶ˆæ¯
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                messages: [
                    // åªåŒ…å«èµ·å§‹ç‚¹åŠä¹‹å‰çš„æ¶ˆæ¯
                    ...currentBranch.messages.slice(0, startingPoint + 1)
                ],
                parent: {
                    branch: conversationData.currentBranch,
                    messageId: fromMessageId
                },
                children: []
            };
            
            // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
            currentBranch.children.push(newBranchId);
            
            // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
            switchBranch(newBranchId);
            
            // éšè—é¢æ¿
            hideBranchCreatePanel();
        }

        // åˆ‡æ¢åˆ†æ”¯
        function switchBranch(branchId) {
            conversationData.currentBranch = branchId;
            renderBranchTree();
            renderCurrentBranch();
        }

        // åˆ‡æ¢å†…å®¹æ ‡è®°çŠ¶æ€
        function toggleContentMark(messageId, content, role) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            const markButton = messageElement.querySelector('.mark-content');
            
            // æ£€æŸ¥æ˜¯å¦å·²æ ‡è®°
            const isMarked = markedContents.some(item => item.messageId === messageId);
            
            if (isMarked) {
                // å–æ¶ˆæ ‡è®°
                markedContents = markedContents.filter(item => item.messageId !== messageId);
                messageElement.classList.remove('content-marked');
                markButton.title = 'æ ‡è®°å†…å®¹';
                markButton.textContent = 'â­';
            } else {
                // æ ‡è®°å†…å®¹å¹¶ç‹¬ç«‹å­˜å‚¨
                markedContents.push({
                    id: 'mc' + Date.now(),
                    messageId: messageId,
                    content: content,
                    role: role,
                    timestamp: new Date(),
                    sourceBranch: conversationData.currentBranch
                });
                messageElement.classList.add('content-marked');
                markButton.title = 'å–æ¶ˆæ ‡è®°';
                markButton.textContent = 'â˜…';
                
                // æ˜¾ç¤ºæ ‡è®°æˆåŠŸçš„æç¤º
                showToast('å†…å®¹å·²æ ‡è®°å¹¶ç‹¬ç«‹å­˜å‚¨');
            }
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // æ·»åŠ åŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // æ˜¾ç¤ºåˆå¹¶åˆ†æ”¯é¢æ¿
        function showMergePanel() {
            const panel = document.getElementById('mergePanel');
            const branchesList = document.getElementById('mergeBranchesList');
            
            branchesList.innerHTML = '';
            
            // æ·»åŠ å¯åˆå¹¶çš„åˆ†æ”¯ï¼ˆæ’é™¤å½“å‰åˆ†æ”¯ï¼‰
            Object.keys(conversationData.branches).forEach(branchId => {
                if (branchId !== conversationData.currentBranch) {
                    const branch = conversationData.branches[branchId];
                    const branchElement = document.createElement('div');
                    branchElement.className = 'merge-branch';
                    branchElement.dataset.branchId = branchId;
                    branchElement.textContent = branch.name;
                    
                    branchElement.addEventListener('click', function() {
                        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('.merge-branch').forEach(el => {
                            el.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    });
                    
                    branchesList.appendChild(branchElement);
                }
            });
            
            panel.style.display = 'block';
            panel.style.top = '50%';
            panel.style.left = '50%';
            panel.style.transform = 'translate(-50%, -50%)';
        }

        // éšè—åˆå¹¶åˆ†æ”¯é¢æ¿
        function hideMergePanel() {
            document.getElementById('mergePanel').style.display = 'none';
        }

        // ç”Ÿæˆä¼šè¯æ‘˜è¦
        function generateConversationSummary(messages) {
            // ç®€å•å®ç°ï¼šæå–å…³é”®ä¿¡æ¯å’Œä¸»è¦é—®é¢˜
            const userMessages = messages.filter(m => m.role === 'user');
            const aiResponses = messages.filter(m => m.role === 'ai');
            
            // æå–å…³é”®è¯
            let keywords = [];
            userMessages.forEach(msg => {
                // ç®€å•çš„å…³é”®è¯æå–é€»è¾‘
                const words = msg.content.toLowerCase().split(/\s+/);
                const importantWords = words.filter(word => 
                    word.length > 3 && 
                    !['the', 'and', 'but', 'or', 'because', 'so', 'is', 'are', 'was', 'were'].includes(word)
                );
                keywords = [...keywords, ...importantWords];
            });
            
            // ç»Ÿè®¡å…³é”®è¯é¢‘ç‡
            const keywordFreq = {};
            keywords.forEach(keyword => {
                keywordFreq[keyword] = (keywordFreq[keyword] || 0) + 1;
            });
            
            // å–æœ€é¢‘ç¹çš„5ä¸ªå…³é”®è¯
            const topKeywords = Object.entries(keywordFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => entry[0])
                .join(', ');
            
            // ç”Ÿæˆæ‘˜è¦
            return `[åˆ†æ”¯"${conversationData.branches[conversationData.currentBranch].name}"çš„å¯¹è¯æ‘˜è¦]\n\n` +
                   `è¿™æ˜¯ä¸€ä¸ªåŒ…å«${userMessages.length}ä¸ªç”¨æˆ·æé—®å’Œ${aiResponses.length}ä¸ªAIå›å¤çš„å¯¹è¯ã€‚\n\n` +
                   `ä¸»è¦è®¨è®ºå†…å®¹å›´ç»•ï¼š${topKeywords}\n\n` +
                   `ç”¨æˆ·çš„ä¸»è¦é—®é¢˜æ˜¯ï¼š${userMessages.length > 0 ? userMessages[0].content.substring(0, 100) + '...' : 'æ— '}`;
        }
        
        // æ˜¾ç¤ºå·²æ ‡è®°å†…å®¹é¢æ¿
        function showMarkedContents() {
            const modal = document.getElementById('markedContentsModal');
            const markedList = document.getElementById('markedContentsList');
            
            // æ¸…ç©ºåˆ—è¡¨
            markedList.innerHTML = '';
            
            if (markedContents.length === 0) {
                markedList.innerHTML = '<div class="empty-state">æš‚æ— å·²æ ‡è®°çš„å†…å®¹</div>';
            } else {
                // æŒ‰æ—¶é—´æ’åº
                const sortedMarkedContents = [...markedContents].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // éå†æ‰€æœ‰å·²æ ‡è®°çš„å†…å®¹
                sortedMarkedContents.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'marked-content-item';
                    
                    const date = new Date(item.timestamp);
                    const formattedDate = date.toLocaleString();
                    
                    itemElement.innerHTML = `
                        <div class="marked-content-header">
                            <span class="marked-content-type">${item.role === 'user' ? 'ç”¨æˆ·' : 'AI'}</span>
                            <span class="marked-content-date">${formattedDate}</span>
                            <button class="delete-marked" data-id="${item.messageId}" title="åˆ é™¤æ ‡è®°">ğŸ—‘ï¸</button>
                        </div>
                        <div class="marked-content-body">${item.content}</div>
                    `;
                    
                    // æ·»åŠ åˆ é™¤äº‹ä»¶
                    itemElement.querySelector('.delete-marked').addEventListener('click', function() {
                        const messageId = this.getAttribute('data-id');
                        toggleContentMark(messageId, '', ''); // å–æ¶ˆæ ‡è®°
                        showMarkedContents(); // åˆ·æ–°åˆ—è¡¨
                    });
                    
                    markedList.appendChild(itemElement);
                });
            }
            
            modal.style.display = 'block';
        }
        
        // éšè—å·²æ ‡è®°å†…å®¹é¢æ¿
        function hideMarkedContents() {
            document.getElementById('markedContentsModal').style.display = 'none';
        }
        
        // åˆå¹¶åˆ†æ”¯
        function mergeBranches() {
            const selectedBranch = document.querySelector('.merge-branch.selected');
            
            if (selectedBranch) {
                const branchId = selectedBranch.dataset.branchId;
                const currentBranch = conversationData.branches[conversationData.currentBranch];
                const branchToMerge = conversationData.branches[branchId];
                
                // è·å–ç”¨æˆ·é€‰æ‹©çš„åˆå¹¶æ–¹å¼
                const mergeType = document.querySelector('input[name="mergeType"]:checked').value;
                
                if (mergeType === 'migrate') {
                    // æ–¹å¼1ï¼šè¿ç§»æ‰€æœ‰èŠå¤©æ°”æ³¡ï¼ŒæŒ‰æ—¶é—´é¡ºåºé‡æ’
                    // å¤åˆ¶æ‰€æœ‰æ¶ˆæ¯å¹¶ç”Ÿæˆæ–°çš„ID
                    const migratedMessages = branchToMerge.messages.map(msg => ({
                        ...msg,
                        id: 'm' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date(msg.timestamp) // ä¿æŒåŸå§‹æ—¶é—´æˆ³
                    }));
                    
                    // åˆå¹¶å¹¶æŒ‰æ—¶é—´æ’åº
                    currentBranch.messages = [...currentBranch.messages, ...migratedMessages]
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                } else if (mergeType === 'summary') {
                    // æ–¹å¼2ï¼šç”Ÿæˆæ‘˜è¦ï¼Œä½œä¸ºå•ä¸ªæ°”æ³¡æ·»åŠ 
                    const summary = generateConversationSummary(branchToMerge.messages);
                    
                    currentBranch.messages.push({
                        id: 'm' + Date.now(),
                        role: 'system',
                        content: `[æ¥è‡ªåˆ†æ”¯"${branchToMerge.name}"çš„æ‘˜è¦]\n\n${summary}`,
                        timestamp: new Date()
                    });
                }
                
                renderCurrentBranch();
                renderBranchTree();
                hideMergePanel();
            }
        }
        
        // åˆ‡æ¢æ¶ˆæ¯é€‰æ‹©çŠ¶æ€
        function toggleMessageSelection(messageId) {
            const index = selectedMessages.indexOf(messageId);
            
            if (index > -1) {
                // å–æ¶ˆé€‰æ‹©
                selectedMessages.splice(index, 1);
                document.querySelector(`[data-message-id="${messageId}"]`).classList.remove('selected');
            } else {
                // é€‰æ‹©æ¶ˆæ¯
                selectedMessages.push(messageId);
                document.querySelector(`[data-message-id="${messageId}"]`).classList.add('selected');
            }
            
            updateSelectionUI();
        }
        
        // æ›´æ–°é€‰æ‹©UI
        function updateSelectionUI() {
            const selectionCount = document.getElementById('selectionCount');
            const selectionActions = document.getElementById('selectionActions');
            
            selectionCount.textContent = `å·²é€‰æ‹© ${selectedMessages.length} æ¡æ¶ˆæ¯`;
            
            if (selectedMessages.length > 0) {
                selectionActions.style.display = 'flex';
            } else {
                selectionActions.style.display = 'none';
            }
        }
        
        // æ¸…é™¤æ¶ˆæ¯é€‰æ‹©
        function clearMessageSelection() {
            selectedMessages.forEach(messageId => {
                document.querySelector(`[data-message-id="${messageId}"]`).classList.remove('selected');
            });
            
            selectedMessages = [];
            updateSelectionUI();
        }
        
        // åŸºäºé€‰ä¸­å†…å®¹åˆ›å»ºåˆ†æ”¯
        function createBranchFromSelection() {
            if (selectedMessages.length === 0) {
                return;
            }
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // è·å–é€‰ä¸­çš„æ¶ˆæ¯å¹¶ä¿æŒé¡ºåº
            const selectedMessagesData = selectedMessages
                .map(messageId => {
                    const message = currentBranch.messages.find(m => m.id === messageId);
                    return message ? { ...message, id: 'm' + Date.now() + '_' + messageId } : null;
                })
                .filter(Boolean);
            
            // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«é€‰ä¸­çš„æ¶ˆæ¯
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `å¤šé€‰åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                messages: selectedMessagesData,
                parent: {
                    branch: conversationData.currentBranch,
                    messageIds: [...selectedMessages] // ä¿å­˜æ‰€æœ‰é€‰ä¸­çš„æ¶ˆæ¯IDç”¨äºå¼•ç”¨
                },
                children: []
            };
            
            // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
            currentBranch.children.push(newBranchId);
            
            // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
            switchBranch(newBranchId);
            
            // æ¸…é™¤é€‰æ‹©
            clearMessageSelection();
        }
        
        // æ˜¾ç¤ºæµç¨‹å›¾
        function showFlowGraph() {
            const modal = document.getElementById('flowGraphModal');
            modal.style.display = 'flex';
            drawFlowGraph();
        }
        
        // éšè—æµç¨‹å›¾
        function hideFlowGraph() {
            document.getElementById('flowGraphModal').style.display = 'none';
        }
        
        // ç»˜åˆ¶æµç¨‹å›¾
        function drawFlowGraph() {
            const svg = document.getElementById('flowGraphSvg');
            svg.innerHTML = '';
            
            // è·å–SVGå°ºå¯¸
            const width = svg.clientWidth;
            const height = svg.clientHeight;
            
            // è®¾ç½®SVGå±æ€§
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            
            // è®¡ç®—èŠ‚ç‚¹ä½ç½®çš„ç®€å•å¸ƒå±€ç®—æ³•
            const nodes = {};
            const edges = [];
            const nodeSize = 80;
            const horizontalSpacing = 200;
            const verticalSpacing = 100;
            
            // è®¡ç®—å±‚æ¬¡ç»“æ„
            const levels = {};
            const rootBranches = [];
            
            // æ‰¾åˆ°æ ¹åˆ†æ”¯
            Object.keys(conversationData.branches).forEach(branchId => {
                if (!conversationData.branches[branchId].parent) {
                    rootBranches.push(branchId);
                }
            });
            
            // åˆ†é…èŠ‚ç‚¹ä½ç½®
            function assignPositions(branchId, level = 0, position = 0) {
                if (!levels[level]) {
                    levels[level] = 0;
                }
                
                const actualPosition = levels[level]++;
                const x = 100 + level * horizontalSpacing;
                const y = 100 + actualPosition * verticalSpacing;
                
                nodes[branchId] = { x, y };
                
                // å¤„ç†å­åˆ†æ”¯
                const branch = conversationData.branches[branchId];
                branch.children.forEach((childId, idx) => {
                    edges.push({ from: branchId, to: childId });
                    assignPositions(childId, level + 1, idx);
                });
            }
            
            // ä»æ ¹åˆ†æ”¯å¼€å§‹åˆ†é…ä½ç½®
            rootBranches.forEach((branchId, idx) => {
                assignPositions(branchId);
            });
            
            // ç»˜åˆ¶è¿æ¥çº¿
            edges.forEach(edge => {
                const from = nodes[edge.from];
                const to = nodes[edge.to];
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                line.classList.add('graph-edge');
                
                // ç®€å•çš„è´å¡å°”æ›²çº¿è¿æ¥
                const path = `M ${from.x + nodeSize/2} ${from.y + nodeSize/2} C ${(from.x + to.x)/2} ${from.y + nodeSize/2}, ${(from.x + to.x)/2} ${to.y + nodeSize/2}, ${to.x - nodeSize/2} ${to.y + nodeSize/2}`;
                line.setAttribute('d', path);
                svg.appendChild(line);
            });
            
            // ç»˜åˆ¶èŠ‚ç‚¹
            Object.keys(nodes).forEach(branchId => {
                const node = nodes[branchId];
                const branch = conversationData.branches[branchId];
                const isActive = branchId === conversationData.currentBranch;
                
                const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                nodeGroup.classList.add('graph-node');
                if (isActive) {
                    nodeGroup.classList.add('active');
                }
                
                // èŠ‚ç‚¹åœ†
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', node.x + nodeSize/2);
                circle.setAttribute('cy', node.y + nodeSize/2);
                circle.setAttribute('r', nodeSize/2);
                circle.setAttribute('fill', branch.parent ? '#f0f0f0' : 'var(--user-bubble)');
                
                // èŠ‚ç‚¹æ–‡æœ¬
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', node.x + nodeSize/2);
                text.setAttribute('y', node.y + nodeSize/2);
                text.setAttribute('dy', '0.3em');
                
                // æˆªæ–­é•¿æ–‡æœ¬
                const shortName = branch.name.length > 8 ? branch.name.substring(0, 8) + '...' : branch.name;
                text.textContent = shortName;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                nodeGroup.addEventListener('click', () => {
                    hideFlowGraph();
                    switchBranch(branchId);
                });
                
                nodeGroup.appendChild(circle);
                nodeGroup.appendChild(text);
                svg.appendChild(nodeGroup);
            })
          
        }
        
        // ç”Ÿæˆæ‘˜è¦
        function generateSummary() {
            if (selectedMessages.length === 0) {
                return;
            }
            
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // è·å–é€‰ä¸­çš„æ¶ˆæ¯å¹¶ä¿æŒé¡ºåº
            const selectedMessagesData = currentBranch.messages
                .filter(message => selectedMessages.includes(message.id))
                .sort((a, b) => currentBranch.messages.indexOf(a) - currentBranch.messages.indexOf(b));
            
            // ç®€å•çš„æ‘˜è¦ç”Ÿæˆé€»è¾‘
            let summary = "";
            
            // ç»Ÿè®¡ç”¨æˆ·å’ŒAIçš„å‘è¨€æ¬¡æ•°
            const userMessages = selectedMessagesData.filter(m => m.role === 'user');
            const aiMessages = selectedMessagesData.filter(m => m.role === 'ai');
            
            // æå–å…³é”®è¯ï¼ˆç®€å•å®ç°ï¼‰
            const keywords = extractKeywords(selectedMessagesData.map(m => m.content).join(' '));
            
            // ç”Ÿæˆæ‘˜è¦æ–‡æœ¬
            summary += `è¿™æ®µå¯¹è¯åŒ…å« ${userMessages.length} æ¡ç”¨æˆ·æ¶ˆæ¯å’Œ ${aiMessages.length} æ¡AIå›å¤ã€‚\n\n`;
            
            if (keywords.length > 0) {
                summary += `è®¨è®ºçš„ä¸»è¦å…³é”®è¯ï¼š${keywords.join(', ')}\n\n`;
            }
            
            // æå–ç”¨æˆ·çš„ä¸»è¦é—®é¢˜
            if (userMessages.length > 0) {
                summary += "ç”¨æˆ·çš„ä¸»è¦é—®é¢˜/å…³æ³¨ç‚¹ï¼š\n";
                userMessages.forEach((msg, idx) => {
                    // åªæ˜¾ç¤ºä¸å¤ªé•¿çš„æ¶ˆæ¯
                    const shortContent = msg.content.length > 80 ? msg.content.substring(0, 80) + '...' : msg.content;
                    summary += `- ${shortContent}\n`;
                });
            }
            
            // æ›´æ–°æ‘˜è¦å†…å®¹
            document.getElementById('summaryContent').textContent = summary;
            
            // æ˜¾ç¤ºæ‘˜è¦æ¨¡æ€æ¡†
            document.getElementById('summaryModal').style.display = 'block';
        }
        
        // ç®€å•çš„å…³é”®è¯æå–å‡½æ•°
        function extractKeywords(text) {
            // ç§»é™¤å¸¸è§åœç”¨è¯
            const stopwords = ['çš„', 'äº†', 'åœ¨', 'æ˜¯', 'æˆ‘', 'æœ‰', 'å’Œ', 'å°±', 'ä¸', 'äºº', 'éƒ½', 'ä¸€', 'ä¸€ä¸ª', 'ä¸Š', 'ä¹Ÿ', 'å¾ˆ', 'åˆ°', 'è¯´', 'è¦', 'å»', 'ä½ ', 'ä¼š', 'ç€', 'æ²¡æœ‰', 'çœ‹', 'å¥½', 'è‡ªå·±', 'è¿™'];
            
            // åˆ†è¯å¹¶è¿‡æ»¤
            const words = text
                .replace(/[.,?!;:"â€œâ€â€˜â€™()\[\]{}]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 1 && !stopwords.includes(word))
                .map(word => word.toLowerCase());
            
            // ç»Ÿè®¡è¯é¢‘
            const wordCounts = {};
            words.forEach(word => {
                wordCounts[word] = (wordCounts[word] || 0) + 1;
            });
            
            // æ’åºå¹¶è¿”å›å‰5ä¸ªå…³é”®è¯
            return Object.keys(wordCounts)
                .sort((a, b) => wordCounts[b] - wordCounts[a])
                .slice(0, 5);
        }
        
        // éšè—æ‘˜è¦
        function hideSummary() {
            document.getElementById('summaryModal').style.display = 'none';
        }
        
        // åŸºäºæ‘˜è¦åˆ›å»ºåˆ†æ”¯
        function createBranchFromSummary() {
            const summary = document.getElementById('summaryContent').textContent;
            
            const newBranchId = 'branch_' + Date.now();
            const currentBranch = conversationData.branches[conversationData.currentBranch];
            
            // åˆ›å»ºæ–°åˆ†æ”¯ - åªåŒ…å«æ‘˜è¦æ¶ˆæ¯
            conversationData.branches[newBranchId] = {
                id: newBranchId,
                name: `æ‘˜è¦åˆ†æ”¯ ${Object.keys(conversationData.branches).length}`,
                messages: [
                    {
                        id: 'm' + Date.now(),
                        role: 'user',
                        content: 'åŸºäºä»¥ä¸‹æ‘˜è¦ç»§ç»­è®¨è®ºï¼š\n' + summary,
                        timestamp: new Date()
                    }
                ],
                parent: {
                    branch: conversationData.currentBranch,
                    summaryBased: true,
                    messageIds: [...selectedMessages] // ä¿å­˜æ‰€æœ‰é€‰ä¸­çš„æ¶ˆæ¯IDç”¨äºå¼•ç”¨
                },
                children: []
            };
            
            // å°†æ–°åˆ†æ”¯æ·»åŠ åˆ°å½“å‰åˆ†æ”¯çš„å­åˆ†æ”¯ä¸­
            currentBranch.children.push(newBranchId);
            
            // åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
            switchBranch(newBranchId);
            
            // éšè—æ‘˜è¦æ¨¡æ€æ¡†
            hideSummary();
            
            // æ¸…é™¤é€‰æ‹©
            clearMessageSelection();
        }
    </script>
</body>
</html>